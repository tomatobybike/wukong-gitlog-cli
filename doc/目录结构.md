You:

index.mjs

æ–‡ä»¶

æˆ‘æœ‰ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·

ChatGPT:

ä½ è¿™ä¸ªé¡¹ç›®**åŠŸèƒ½å¾ˆå¼ºï¼Œä½†â€œèŒè´£è¾¹ç•Œâ€å·²ç»å¼€å§‹å¡Œäº†**ã€‚
ä»ä½ ç»™çš„ç»“æ„ + `index.mjs` å…¥å£ä»£ç æ¥çœ‹ï¼Œç°åœ¨çš„é—®é¢˜ä¸æ˜¯â€œæ–‡ä»¶å¤šâ€ï¼Œè€Œæ˜¯ **å±‚æ¬¡æ··ä¹± + æ¨ªåˆ‡é€»è¾‘å †åœ¨å…¥å£**ã€‚

æˆ‘åˆ† **3 ä¸ªå±‚æ¬¡** æ¥è®²ï¼š
ğŸ‘‰ **ç°çŠ¶è¯Šæ–­ â†’ ç»“æ„é‡æ„å»ºè®® â†’ å…·ä½“å¯è½åœ°çš„ç›®å½•æ–¹æ¡ˆï¼ˆå«è¿ç§»æ­¥éª¤ï¼‰**

---

## ä¸€ã€ç°çŠ¶è¯Šæ–­ï¼ˆä¸ºä»€ä¹ˆä½ ä¼šè§‰å¾—â€œä¹±â€ï¼‰

### 1ï¸âƒ£ å…¥å£ `index.mjs` å·²ç»æ˜¯ã€Œä¸Šå¸æ–‡ä»¶ã€

ä½ ç°åœ¨çš„ `index.mjs` åŒæ—¶åœ¨åšï¼š

-   CLI å‚æ•°å®šä¹‰ï¼ˆCommanderï¼‰

-   é…ç½®è§£æ

-   Git æ•°æ®è·å–

-   Gerrit API è§£æ

-   Overtime ä¸šåŠ¡é€»è¾‘

-   æœˆ / å‘¨ / per-period è¾“å‡º

-   JSON / Text / Excel / CSV / Tab

-   Web serve

-   æ€§èƒ½åˆ†æï¼ˆprofilerï¼‰

-   æ›´æ–°æ£€æŸ¥

-   IOï¼ˆæ–‡ä»¶è·¯å¾„ã€å†™æ–‡ä»¶ï¼‰


ğŸ‘‰ **è¿™æ˜¯å…¸å‹çš„ CLI é¡¹ç›®â€œç¬¬äºŒé˜¶æ®µè†¨èƒ€ç—‡â€**

ä¸€å¼€å§‹ CLI éƒ½è¿™æ ·ï¼Œåé¢ä¸æ‹†å°±ä¸€å®šä¼šçˆ†ã€‚

---

### 2ï¸âƒ£ `src/` ä¸‹çš„ç›®å½•â€œåˆ†ç±»æ ‡å‡†ä¸ç»Ÿä¸€â€

ä½ ç°åœ¨æ··ç”¨äº† **4 å¥—åˆ†ç±»æ–¹å¼**ï¼š

| åˆ†ç±»æ–¹å¼ | ç¤ºä¾‹ |
| --- | --- |
| æŠ€æœ¯å±‚ | `utils/`, `lib/` |
| ä¸šåŠ¡åŸŸ | `overtime/` |
| è¡¨ç°å½¢å¼ | `text.mjs`, `excel.mjs`, `json.mjs` |
| è¿è¡Œæ¨¡å¼ | `server.mjs`, `handlers/handleServe.mjs` |

ç»“æœæ˜¯ï¼š

-   `renderAuthorMapText.mjs` åœ¨ root

-   `stats-text.mjs`ã€`text.mjs` æ„ä¹‰é‡å 

-   `utils/index.mjs` å·²ç»æˆäº†â€œå·¥å…·åƒåœ¾æ¡¶â€

-   `handlers/` åªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œåä¸å‰¯å®


---

### 3ï¸âƒ£ `output-wukong/` è¯­ä¹‰æ­£ç¡®ï¼Œä½†â€œç”Ÿæˆç»“æ„åæ¨ä¸äº†ä»£ç ç»“æ„â€

ä½ ç”Ÿæˆçš„è¾“å‡ºæ˜¯ **é«˜åº¦ç»“æ„åŒ–çš„**ï¼ˆmonth / week / data / csvï¼‰ï¼Œ
ä½†ä»£ç å´æ²¡æœ‰å¯¹åº”çš„ **â€œè¾“å‡ºåŸŸæ¨¡å—â€**ã€‚

ğŸ‘‰ è¿™è¯´æ˜**ä»£ç ç»“æ„å·²ç»è½åäºåŠŸèƒ½è®¾è®¡**ã€‚

---

## äºŒã€æ ¸å¿ƒé‡æ„åŸåˆ™ï¼ˆå¾ˆé‡è¦ï¼‰

ä¸‹é¢è¿™ 4 æ¡ï¼Œæ˜¯æˆ‘å»ºè®®ä½ åç»­**é•¿æœŸéµå®ˆ**çš„åŸåˆ™ï¼š

---

### âœ… åŸåˆ™ 1ï¼šå…¥å£æ–‡ä»¶ = orchestrationï¼Œä¸åšä¸šåŠ¡

`index.mjs` åªå…è®¸ï¼š

-   CLI å‚æ•°å®šä¹‰

-   è°ƒåº¦ï¼ˆif / switchï¼‰

-   è°ƒç”¨ use case

-   é”™è¯¯å…œåº•


**ä¸å…è®¸**ï¼š

-   ç›´æ¥å†™æ–‡ä»¶

-   ç›´æ¥ groupRecords

-   ç›´æ¥ month/week å¾ªç¯


---

### âœ… åŸåˆ™ 2ï¼šæŒ‰ã€Œä¸šåŠ¡åŸŸã€ä¼˜å…ˆäºã€ŒæŠ€æœ¯åˆ†ç±»ã€

> **overtime æ˜¯ä¸€çº§å…¬æ°‘**

æ¯” `utils` / `lib` æ›´é‡è¦ã€‚

---

### âœ… åŸåˆ™ 3ï¼šè¾“å‡º = ä¸€ä¸ªæ˜ç¡®çš„å­ç³»ç»Ÿ

Text / JSON / Excel / CSV ä¸æ˜¯â€œæ ¼å¼â€ï¼Œ
è€Œæ˜¯ **Output Pipelines**ã€‚

---

### âœ… åŸåˆ™ 4ï¼šserve æ˜¯ä¸€ç§ modeï¼Œä¸æ˜¯ handler

`--serve` / `--serve-only` æ˜¯è¿è¡Œæ¨¡å¼ï¼Œä¸æ˜¯â€œå¤„ç†å‡½æ•°â€ã€‚

---

## ä¸‰ã€æ¨èçš„ç›®å½•ç»“æ„ï¼ˆCLI å·¥å…·çš„æˆç†Ÿå½¢æ€ï¼‰

### âœ… æ¨è v2 ç›®å½•ç»“æ„ï¼ˆæ ¸å¿ƒï¼‰

```text
src/
â”œâ”€â”€ cli/                  # CLI ç›¸å…³ï¼ˆCommanderï¼‰
â”‚   â”œâ”€â”€ defineOptions.mjs
â”‚   â”œâ”€â”€ parseOptions.mjs
â”‚   â””â”€â”€ index.mjs         # åªè´Ÿè´£ program.parse
â”‚
â”œâ”€â”€ app/                  # åº”ç”¨å±‚ï¼ˆUse Casesï¼‰
â”‚   â”œâ”€â”€ runAnalyze.mjs    # ä¸»åˆ†ææµç¨‹
â”‚   â”œâ”€â”€ runServe.mjs
â”‚   â”œâ”€â”€ runVersion.mjs
â”‚   â””â”€â”€ runExport.mjs
â”‚
â”œâ”€â”€ domain/               # ä¸šåŠ¡åŸŸï¼ˆæœ€é‡è¦ï¼‰
â”‚   â”œâ”€â”€ git/
â”‚   â”‚   â”œâ”€â”€ getGitLogs.mjs
â”‚   â”‚   â””â”€â”€ gerritResolver.mjs
â”‚   â”‚
â”‚   â”œâ”€â”€ overtime/
â”‚   â”‚   â”œâ”€â”€ analyze.mjs
â”‚   â”‚   â”œâ”€â”€ stats.mjs
â”‚   â”‚   â”œâ”€â”€ perPeriod.mjs
â”‚   â”‚   â””â”€â”€ index.mjs
â”‚   â”‚
â”‚   â””â”€â”€ author/
â”‚       â”œâ”€â”€ normalize.mjs
â”‚       â””â”€â”€ stats.mjs
â”‚
â”œâ”€â”€ output/               # æ‰€æœ‰è¾“å‡ºé€»è¾‘
â”‚   â”œâ”€â”€ text/
â”‚   â”œâ”€â”€ json/
â”‚   â”œâ”€â”€ excel/
â”‚   â”œâ”€â”€ csv/
â”‚   â”œâ”€â”€ tab/
â”‚   â””â”€â”€ index.mjs
â”‚
â”œâ”€â”€ serve/
â”‚   â”œâ”€â”€ startServer.mjs
â”‚   â”œâ”€â”€ writeServeData.mjs
â”‚   â””â”€â”€ index.mjs
â”‚
â”œâ”€â”€ infra/                # åŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ fs.mjs
â”‚   â”œâ”€â”€ path.mjs
â”‚   â”œâ”€â”€ configStore.mjs
â”‚   â””â”€â”€ cache.mjs
â”‚
â”œâ”€â”€ utils/                # çº¯å·¥å…·ï¼ˆæ— ä¸šåŠ¡ï¼‰
â”‚   â”œâ”€â”€ time.mjs
â”‚   â”œâ”€â”€ logger.mjs
â”‚   â”œâ”€â”€ profiler.mjs
â”‚   â””â”€â”€ index.mjs
â”‚
â””â”€â”€ index.mjs             # ğŸš¨ æè–„å…¥å£
```

---

## å››ã€`index.mjs` åº”è¯¥é•¿ä»€ä¹ˆæ ·ï¼ˆç¤ºæ„ï¼‰

```js
import { parseCli } from './cli/index.mjs'
import { runAnalyze } from './app/runAnalyze.mjs'
import { runServe } from './app/runServe.mjs'
import { runVersion } from './app/runVersion.mjs'

const opts = parseCli()

if (opts.version) {
  await runVersion()
  return
}

if (opts.serveOnly) {
  await runServe(opts)
  return
}

await runAnalyze(opts)
```

ğŸ‘‰ **ä½ ç°åœ¨ 900 è¡Œçš„ index.mjsï¼Œç›®æ ‡æ˜¯ â‰¤ 80 è¡Œ**

---

## äº”ã€ä½ å¯ä»¥â€œæ¸è¿›å¼â€åšï¼Œä¸ç”¨ä¸€æ¬¡é‡æ„å®Œ

### ğŸš€ æ¨èè¿ç§»é¡ºåºï¼ˆå®‰å…¨ï¼‰

1ï¸âƒ£ **å…ˆæ‹† Gerrit é€»è¾‘**

-   æŠ½æˆ `domain/git/gerritResolver.mjs`

-   index.mjs ç«‹åˆ»ç˜¦ 150 è¡Œ


2ï¸âƒ£ **æ‹† overtime**

-   `createOvertimeStats`

-   month / week / perPeriod å…¨ç§»å…¥ domain


3ï¸âƒ£ **ç»Ÿä¸€ output å±‚**

-   æ‰€æœ‰ writeTextFile / writeJSON / exportExcel éƒ½ç§»èµ°


4ï¸âƒ£ æœ€åå†æ¸…ç† utils / lib

---

## å…­ã€ä¸€å¥æ€»ç»“ï¼ˆé‡ç‚¹ï¼‰

> **ä½ è¿™ä¸ªé¡¹ç›®å·²ç»ä¸æ˜¯â€œè„šæœ¬çº§ CLIâ€ï¼Œè€Œæ˜¯â€œå°å‹æ•°æ®åˆ†æåº”ç”¨â€**

å¦‚æœä½ ç»§ç»­ç”¨ã€Œutils + index å †é€»è¾‘ã€çš„æ–¹å¼å†™ä¸‹å»ï¼š

-   æ–°åŠŸèƒ½ä¼šè¶Šæ¥è¶Šæ…¢

-   ä½ è‡ªå·±ä¸‰ä¸ªæœˆåéƒ½ä¸æ•¢æ”¹


ä½†å¦‚æœä½ æŒ‰ **domain + app + output** æ‹†å®Œï¼š

-   è¿™æ˜¯ä¸€ä¸ª**å¯ä»¥é•¿æœŸç»´æŠ¤ã€å¯æ‰©å±•çš„ CLI äº§å“**

-   ç”šè‡³å¯ä»¥ç›´æ¥åšæˆ GitHub Star é¡¹ç›®


---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ ï¼š

-   ğŸ”¥ **ç›´æ¥ç»™ä½ ä¸€ä¸ªâ€œindex.mjs â†’ runAnalyze.mjsâ€çš„å®æ‹†ç‰ˆæœ¬**

-   ğŸ§± å¸®ä½ è®¾è®¡ `domain/overtime` çš„æœ€ç»ˆ API

-   ğŸ“¦ è®¾è®¡ä¸€ä¸ªæ’ä»¶å¼ output systemï¼ˆæœªæ¥æ”¯æŒ markdown / htmlï¼‰


ä½ æƒ³ä»å“ªä¸€å—å¼€å§‹æ‹†ï¼Ÿ

You:

ä½ ç›´æ¥è¾“å‡º å¯ç”¨äºç”Ÿäº§çš„å§

ChatGPT:

å¥½ï¼Œé‚£æˆ‘**ç›´æ¥ç»™ä½ ä¸€å¥—ã€Œå¯ç”¨äºç”Ÿäº§ã€çš„æ–¹æ¡ˆ**ï¼Œä¸æ˜¯æ¦‚å¿µç¨¿ï¼Œè€Œæ˜¯ä½ **ç°åœ¨è¿™ä¸ªé¡¹ç›®å¯ä»¥ç«‹åˆ»æŒ‰å›¾æ–½å·¥çš„ç‰ˆæœ¬**ã€‚
ç›®æ ‡åªæœ‰ä¸€ä¸ªï¼š**ä½ ç…§ç€æ‹†ï¼Œä¸éœ€è¦å†æƒ³æ¶æ„é—®é¢˜**ã€‚

æˆ‘ä¼šç»™ä½ ï¼š

1.  âœ… **æœ€ç»ˆç›®å½•ç»“æ„ï¼ˆå®šç¨¿ï¼‰**

2.  âœ… **æ–°çš„æè–„ `src/index.mjs`ï¼ˆç”Ÿäº§å¯ç”¨ï¼‰**

3.  âœ… **æ ¸å¿ƒ use caseï¼š`runAnalyze.mjs`ï¼ˆå·²å¸æ”¶ä½ ç°åœ¨ 80% é€»è¾‘ï¼‰**

4.  âœ… **æ‹†åˆ†è§„èŒƒï¼ˆä½ åç»­åŠ åŠŸèƒ½ä¸ä¼šå†ä¹±ï¼‰**

5.  âœ… **è¿ç§»æ¸…å•ï¼ˆä¸€æ­¥æ­¥æ¬ï¼Œä¸ä¼šç‚¸ï¼‰**


---

# ä¸€ã€æœ€ç»ˆç›®å½•ç»“æ„ï¼ˆç”Ÿäº§å®šç¨¿ç‰ˆï¼‰

> è¿™æ˜¯ **CLI + æ•°æ®åˆ†æ + Web Serve** çš„æˆç†Ÿå½¢æ€
> ä¸è¿½æ±‚â€œå­¦æœ¯æ¶æ„â€ï¼Œè¿½æ±‚**ä½ èƒ½é•¿æœŸç»´æŠ¤**

```text
src/
â”œâ”€â”€ index.mjs                 # ğŸš¨ æè–„å…¥å£ï¼ˆåªè°ƒåº¦ï¼‰
â”‚
â”œâ”€â”€ cli/
â”‚   â”œâ”€â”€ defineOptions.mjs     # commander.option å…¨åœ¨è¿™
â”‚   â”œâ”€â”€ parseOptions.mjs
â”‚   â””â”€â”€ index.mjs
â”‚
â”œâ”€â”€ app/                      # åº”ç”¨å±‚ï¼ˆUse Casesï¼‰
â”‚   â”œâ”€â”€ runAnalyze.mjs        # ä¸»åˆ†ææµç¨‹ï¼ˆæœ€é‡ï¼‰
â”‚   â”œâ”€â”€ runServe.mjs
â”‚   â”œâ”€â”€ runVersion.mjs
â”‚   â””â”€â”€ runProfileEnd.mjs
â”‚
â”œâ”€â”€ domain/                   # ä¸šåŠ¡åŸŸï¼ˆç¨³å®šæ ¸å¿ƒï¼‰
â”‚   â”œâ”€â”€ git/
â”‚   â”‚   â”œâ”€â”€ getGitLogs.mjs
â”‚   â”‚   â””â”€â”€ resolveGerrit.mjs
â”‚   â”‚
â”‚   â”œâ”€â”€ overtime/
â”‚   â”‚   â”œâ”€â”€ analyze.mjs
â”‚   â”‚   â”œâ”€â”€ perPeriod.mjs
â”‚   â”‚   â”œâ”€â”€ render.mjs
â”‚   â”‚   â””â”€â”€ index.mjs
â”‚   â”‚
â”‚   â””â”€â”€ author/
â”‚       â”œâ”€â”€ map.mjs
â”‚       â””â”€â”€ stats.mjs
â”‚
â”œâ”€â”€ output/                   # æ‰€æœ‰è¾“å‡ºï¼ˆå¼ºçº¦æŸï¼‰
â”‚   â”œâ”€â”€ text.mjs
â”‚   â”œâ”€â”€ json.mjs
â”‚   â”œâ”€â”€ excel.mjs
â”‚   â”œâ”€â”€ csv.mjs
â”‚   â”œâ”€â”€ tab.mjs
â”‚   â””â”€â”€ index.mjs
â”‚
â”œâ”€â”€ serve/
â”‚   â”œâ”€â”€ writeData.mjs
â”‚   â”œâ”€â”€ startServer.mjs
â”‚   â””â”€â”€ index.mjs
â”‚
â”œâ”€â”€ infra/                    # åŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ fs.mjs
â”‚   â”œâ”€â”€ path.mjs
â”‚   â”œâ”€â”€ configStore.mjs
â”‚   â””â”€â”€ cache.mjs
â”‚
â”œâ”€â”€ utils/                    # çº¯å·¥å…·ï¼ˆæ— ä¸šåŠ¡è¯­ä¹‰ï¼‰
â”‚   â”œâ”€â”€ time.mjs
â”‚   â”œâ”€â”€ groupRecords.mjs
â”‚   â”œâ”€â”€ logger.mjs
â”‚   â”œâ”€â”€ profiler.mjs
â”‚   â””â”€â”€ index.mjs
â”‚
â””â”€â”€ constants/
    â””â”€â”€ index.mjs
```

---

# äºŒã€ç”Ÿäº§çº§ `src/index.mjs`ï¼ˆä½ ç°åœ¨ 900 è¡Œ â†’ 60 è¡Œï¼‰

```js
#!/usr/bin/env node
import { parseCli } from './cli/index.mjs'
import { runAnalyze } from './app/runAnalyze.mjs'
import { runServe } from './app/runServe.mjs'
import { runVersion } from './app/runVersion.mjs'
import { finalizeProfile } from './app/runProfileEnd.mjs'

let profiler

try {
  const opts = await parseCli()

  profiler = opts.profiler

  if (opts.version) {
    await runVersion(opts)
    return
  }

  if (opts.serveOnly) {
    await runServe(opts)
    return
  }

  await runAnalyze(opts)
} catch (err) {
  console.error(err)
  process.exitCode = 1
} finally {
  if (profiler) {
    finalizeProfile(profiler)
  }
}
```

ğŸ‘‰ **è¿™å°±æ˜¯â€œä¸ä¼šå†è†¨èƒ€çš„å…¥å£æ–‡ä»¶â€**

---

# ä¸‰ã€æ ¸å¿ƒ Use Caseï¼š`runAnalyze.mjs`ï¼ˆå¯ç›´æ¥ç”¨ï¼‰

> è¿™æ˜¯ä½ ç°åœ¨ `index.mjs` çš„**ä¸šåŠ¡æ ¸å¿ƒæ¬è¿ç‰ˆ**

```js
import ora from 'ora'
import path from 'path'

import { getGitLogs } from '../domain/git/getGitLogs.mjs'
import { resolveGerrit } from '../domain/git/resolveGerrit.mjs'
import { analyzeOvertime } from '../domain/overtime/analyze.mjs'
import { writeOutputs } from '../output/index.mjs'
import { handleServeData } from '../serve/index.mjs'
import { handleSuccess } from '../utils/logger.mjs'
import { outputDirFromOptions } from '../infra/path.mjs'

export async function runAnalyze(opts) {
  const spinner = ora('Analyzing git history...').start()

  const outDir = outputDirFromOptions(opts)

  const { records, authorMap } = await getGitLogs(opts)

  const enrichedRecords = opts.gerrit
    ? await resolveGerrit(records, opts)
    : records

  if (opts.serve) {
    await handleServeData({
      records: enrichedRecords,
      authorMap,
      outDir,
      opts
    })
  }

  let overtimeResult = null
  if (opts.overtime) {
    overtimeResult = await analyzeOvertime(enrichedRecords, opts)
  }

  await writeOutputs({
    records: enrichedRecords,
    authorMap,
    overtimeResult,
    outDir,
    opts
  })

  spinner.stop()
  handleSuccess()
}
```

**å…³é”®ç‚¹ï¼š**

-   runAnalyze ä¸çŸ¥é“ **text / excel / json**

-   ä¹Ÿä¸çŸ¥é“ **æœˆ / å‘¨ / CSV**

-   åªåšï¼š**è°ƒåº¦**


---

# å››ã€`domain/overtime`ï¼ˆä½ ç°åœ¨æœ€å¤æ‚çš„åœ°æ–¹ï¼‰

### `domain/overtime/analyze.mjs`

```js
import { createOvertimeStats } from './stats.mjs'
import { buildPerPeriodStats } from './perPeriod.mjs'

export async function analyzeOvertime(records, opts) {
  const getStats = createOvertimeStats(opts)

  const total = getStats(records)

  const monthly = buildPerPeriodStats(records, 'month', getStats)
  const weekly = buildPerPeriodStats(records, 'week', getStats)

  return {
    total,
    monthly,
    weekly
  }
}
```

ğŸ‘‰ **overtime çš„â€œä¸šåŠ¡æ¨¡å‹â€ç»ˆäºç¨³å®šäº†**

---

# äº”ã€Output å±‚ï¼ˆä¸ä¼šå†ä¹±ï¼‰

### `output/index.mjs`

```js
import { writeText } from './text.mjs'
import { writeJson } from './json.mjs'
import { writeExcel } from './excel.mjs'

export async function writeOutputs(ctx) {
  const { opts } = ctx

  if (opts.format === 'json' || opts.json) {
    await writeJson(ctx)
    return
  }

  if (opts.format === 'excel') {
    await writeExcel(ctx)
    return
  }

  await writeText(ctx)
}
```

ğŸ‘‰ **ä»¥åä½ åŠ  markdown / htmlï¼ŒåªåŠ æ–‡ä»¶ï¼Œä¸åŠ¨ä¸šåŠ¡**

---

# å…­ã€å¼ºåˆ¶æ‹†åˆ†è§„èŒƒï¼ˆä»¥åä¸ä¼šå†ä¹±ï¼‰

### âœ… å…è®¸

-   `domain/*` é‡Œåªå¤„ç† **æ•°æ®ä¸è§„åˆ™**

-   `output/*` é‡Œåªå¤„ç† **æ ¼å¼åŒ– & å†™æ–‡ä»¶**

-   `app/*` åªåš orchestration


### âŒ ç¦æ­¢

-   `index.mjs` é‡Œå†™å¾ªç¯

-   `utils` é‡Œå‡ºç° overtime / git / author

-   domain é‡Œå†™æ–‡ä»¶


---

# ä¸ƒã€è¿ç§»æ¸…å•ï¼ˆæŒ‰è¿™ä¸ªé¡ºåºï¼Œæœ€å®‰å…¨ï¼‰

1.  âœ… æ–°å»º `app/runAnalyze.mjs`ï¼ŒæŠŠ index é€»è¾‘æ¬è¿›å»

2.  âœ… Gerrit æŠ½æˆ `domain/git/resolveGerrit.mjs`

3.  âœ… Overtime æŠ½æˆ domainï¼ˆä½ æ”¶ç›Šæœ€å¤§ï¼‰

4.  âœ… Output ç»Ÿä¸€å…¥å£

5.  âœ… æœ€åæ¸…ç† utils / lib


---

## æœ€åä¸€æ®µå®è¯

ä½ è¿™ä¸ªé¡¹ç›® **å·²ç»å®Œå…¨é…å¾—ä¸Šâ€œç”Ÿäº§çº§ CLI æ¶æ„â€**ï¼Œ
ç°åœ¨åªæ˜¯**ä»£ç ç»„ç»‡è¿˜åœç•™åœ¨æ—©æœŸè„šæœ¬é˜¶æ®µ**ã€‚

æŒ‰æˆ‘è¿™å¥—æ‹†å®Œä¹‹åï¼š

-   ä½ ä»¥ååŠ åŠŸèƒ½æ˜¯ã€ŒåŠ æ–‡ä»¶ã€

-   ä¸æ˜¯ã€Œæ”¹ 900 è¡Œ indexã€

-   ä¸‰ä¸ªæœˆåä½ è‡ªå·±ä¹Ÿæ•¢é‡æ„


---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ **ç›´æ¥å¸®ä½ æŠŠã€Œç°æœ‰ index.mjsã€é€æ®µè¿ç§»æˆè¿™äº›æ–‡ä»¶ï¼ˆå¯¹ç…§è¡¨ + diff é£æ ¼ï¼‰**ï¼Œåšåˆ°ä½ å¯ä»¥ä¸€è¾¹æ¬ä¸€è¾¹è·‘ã€‚

ä½ è¦ä¸è¦æˆ‘ä» **Gerrit / Overtime / Output** é‡ŒæŒ‘ä¸€ä¸ªï¼Œç›´æ¥â€œå®æ‹†åˆ°æ–‡ä»¶çº§â€ï¼Ÿ

You:

è¿™ä¸ªç»“æ„æ˜¯å¯¹çš„ï¼Œç°åœ¨ æ˜¯ä¸æ˜¯å¯ä»¥æ‹†åˆ†æˆå‡ ä¸ªå‘½ä»¤ï¼Œæ›´åˆç†

ChatGPT:

æ˜¯çš„ï¼Œ**éå¸¸æœ‰å¿…è¦æ‹†æˆå¤šä¸ªå‘½ä»¤ï¼Œè€Œä¸”ä½ ç°åœ¨è¿™ä¸ªå‚æ•°è§„æ¨¡å·²ç»â€œæ˜æ˜¾è¶…å‡ºå•å‘½ä»¤çš„åˆç†ä¸Šé™â€äº†**ã€‚
è¿™ä¸æ˜¯å®¡ç¾é—®é¢˜ï¼Œè€Œæ˜¯**å¯ç”¨æ€§ + å¯ç»´æŠ¤æ€§**é—®é¢˜ã€‚

æˆ‘ç›´æ¥ç»™ä½ ä¸€ä¸ª **ã€Œç”Ÿäº§çº§ã€å¯è½åœ°ã€çš„æ‹†åˆ†æ–¹æ¡ˆ**ï¼Œä¸æ˜¯æ³›æ³›è€Œè°ˆã€‚

---

# ä¸€ã€å…ˆç»™ç»“è®ºï¼ˆä½ ç°åœ¨çš„é—®é¢˜æœ¬è´¨ï¼‰

ä½ å½“å‰è¿™ä¸ª CLIï¼š

-   è¡¨é¢æ˜¯ **ä¸€ä¸ª command**

-   å®é™…ä¸Šå·²ç»æ˜¯ **4 ç§å®Œå…¨ä¸åŒçš„ use case**


| å®é™…è¡Œä¸º | ç°åœ¨çš„è¡¨ç° |
| --- | --- |
| åˆ†æ git æäº¤ | `git-commits --author --since ...` |
| Overtime åˆ†æ | `--overtime --country --work-start ...` |
| å¯¼å‡º | `--format excel --per-period-*` |
| å¯åŠ¨ web | `--serve / --serve-only` |
| æ€§èƒ½åˆ†æ | `--profile --trace --diff-*` |

ğŸ‘‰ **è¿™äº›æœ¬æ¥å°±ä¸åº”è¯¥å…±äº«åŒä¸€ä¸ªå‘½ä»¤ç©ºé—´**

---

# äºŒã€æ¨èçš„å‘½ä»¤æ‹†åˆ†ï¼ˆç”Ÿäº§å®šç¨¿ï¼‰

## âœ… é¡¶å±‚å‘½ä»¤

```bash
wukong-gitlog <command> [options]
```

### æ‹†æˆ **5 ä¸ªä¸€çº§å‘½ä»¤**

```text
analyze    # æ ¸å¿ƒåˆ†æï¼ˆé»˜è®¤ï¼‰
overtime   # åŠ ç­æ–‡åŒ–åˆ†æ
export     # å¯¼å‡ºï¼ˆexcel / csv / jsonï¼‰
serve      # Web æœåŠ¡
profile    # æ€§èƒ½åˆ†æï¼ˆå†…éƒ¨/é«˜çº§ï¼‰
```

---

# ä¸‰ã€å…·ä½“æ‹†åˆ†æ–¹æ¡ˆï¼ˆä½ å¯ä»¥ç›´æ¥ç…§æŠ„ï¼‰

---

## 1ï¸âƒ£ `analyze`ï¼ˆé»˜è®¤ä¸»å‘½ä»¤ï¼‰

> **80% ç”¨æˆ·åªéœ€è¦è¿™ä¸ª**

```bash
wukong-gitlog analyze [options]
```

### å‚æ•°ï¼ˆç²¾ç®€åï¼‰

```js
program
  .command('analyze')
  .description('Analyze git commit history')
  .option('--author <name>')
  .option('--email <email>')
  .option('--since <date>')
  .option('--until <date>')
  .option('--limit <n>', parseInt)
  .option('--no-merges')
  .option('--group-by <day|week|month>')
  .option('--gerrit <prefix>')
  .option('--gerrit-api <url>')
  .option('--gerrit-auth <token>')
  .option('--out <file>')
  .option('--out-dir <dir>')
  .option('--out-parent')
  .action(runAnalyze)
```

ğŸ‘‰ **æ²¡æœ‰ overtime / serve / excel / profile**

---

## 2ï¸âƒ£ `overtime`ï¼ˆæ˜ç¡®ä¸šåŠ¡è¯­ä¹‰ï¼‰

```bash
wukong-gitlog overtime [options]
```

### å‚æ•°

```js
program
  .command('overtime')
  .description('Analyze overtime culture from git commits')
  .option('--author <name>')
  .option('--since <date>')
  .option('--until <date>')
  .option('--country <CN|US>', 'CN')
  .option('--work-start <hour>', parseInt, 9)
  .option('--work-end <hour>', parseInt, 18)
  .option('--lunch-start <hour>', parseInt, 12)
  .option('--lunch-end <hour>', parseInt, 14)
  .option('--overnight-cutoff <hour>', parseInt, 6)
  .option('--per-period-formats <csv,tab,xlsx>')
  .option('--per-period-excel-mode <sheets|files>', 'sheets')
  .option('--per-period-only')
  .option('--out-dir <dir>')
  .option('--out-parent')
  .action(runOvertime)
```

ğŸ‘‰ **`--overtime` flag å½»åº•æ¶ˆå¤±**

è¿™æ˜¯ä¸€ä¸ª**å·¨å¤§å¯ç”¨æ€§æå‡ç‚¹**ã€‚

---

## 3ï¸âƒ£ `export`ï¼ˆä¸“é—¨è´Ÿè´£æ ¼å¼ï¼‰

```bash
wukong-gitlog export [options]
```

```js
program
  .command('export')
  .description('Export git commit statistics')
  .option('--format <text|json|excel>')
  .option('--stats')
  .option('--group-by <day|week|month>')
  .option('--out <file>')
  .option('--out-dir <dir>')
  .option('--out-parent')
  .action(runExport)
```

ğŸ‘‰ ä¸å†å‡ºç° `--json` + `--format` æ··ç”¨çš„æ­§ä¹‰

---

## 4ï¸âƒ£ `serve`ï¼ˆæ¨¡å¼å‹å‘½ä»¤ï¼‰

```bash
wukong-gitlog serve [options]
```

```js
program
  .command('serve')
  .description('Start local web server')
  .option('--port <n>', parseInt, 3000)
  .option('--out-dir <dir>')
  .option('--out-parent')
  .option('--only', 'Serve only, no analysis')
  .action(runServe)
```

ğŸ‘‰ `--serve` / `--serve-only` è¿™ç§ flag **ä»æ­¤ä¸å†æ±¡æŸ“ analyze**

---

## 5ï¸âƒ£ `profile`ï¼ˆé«˜çº§ / CI / å†…éƒ¨ï¼‰

```bash
wukong-gitlog profile analyze [options]
```

æˆ–ï¼š

```bash
wukong-gitlog analyze --profile
```

### ç°å®å»ºè®®ï¼ˆå¾ˆé‡è¦ï¼‰

ğŸ‘‰ **profile ä¸è¦å•ç‹¬æ‹†æˆå‘½ä»¤**

å®ƒæ˜¯ **cross-cutting concern**ï¼Œæ›´åˆç†çš„åšæ³•æ˜¯ï¼š

-   ä½œä¸º **å…¨å±€ option**

-   ä½†åªå½±å“ app å±‚


```js
program
  .option('--profile')
  .option('--trace <file>')
  .option('--hot-threshold <n>', parseFloat)
  .option('--fail-on-hot')
```

---

# å››ã€Commander ä»£ç ç»“æ„ï¼ˆç”Ÿäº§çº§ï¼‰

### `cli/index.mjs`

```js
import { Command } from 'commander'
import { registerAnalyze } from './commands/analyze.mjs'
import { registerOvertime } from './commands/overtime.mjs'
import { registerServe } from './commands/serve.mjs'

export async function parseCli() {
  const program = new Command()

  program
    .name('wukong-gitlog')
    .version(VERSION)
    .description('Advanced git commit analyzer')

  registerAnalyze(program)
  registerOvertime(program)
  registerServe(program)

  program.parse()

  return program.opts()
}
```

### `cli/commands/analyze.mjs`

```js
export function registerAnalyze(program) {
  program
    .command('analyze')
    .description('Analyze git commit history')
    .option('--author <name>')
    .option('--since <date>')
    .action((opts) => runAnalyze(opts))
}
```

ğŸ‘‰ **CLI æœ¬èº«ä¹Ÿæ¨¡å—åŒ–äº†**

---

# äº”ã€ä¸ºä»€ä¹ˆè¿™å¥—æ‹†åˆ†æ˜¯â€œæ­£ç¡®çš„â€

### âœ… å¯¹ç”¨æˆ·

-   `--help` ä¸å† 200 è¡Œ

-   å‘½ä»¤è¯­ä¹‰ç›´è§‚

-   ä¸éœ€è¦è®° flag ç»„åˆ


### âœ… å¯¹ä½ 

-   æ–°åŠŸèƒ½ = æ–°å‘½ä»¤

-   åˆ é™¤åŠŸèƒ½ = åˆ é™¤ command

-   index.mjs æ°¸è¿œä¸è†¨èƒ€


### âœ… å¯¹æœªæ¥

-   ä½ ä»¥åå¯ä»¥ï¼š

    -   `wukong-gitlog report`

    -   `wukong-gitlog compare`

    -   `wukong-gitlog stats`


è€Œä¸ç”¨æ”¹æ—§å‘½ä»¤ã€‚

---

# å…­ã€å…³é”®åˆ¤æ–­æ ‡å‡†ï¼ˆä½ ä»¥åå¯ä»¥è‡ªå·±åˆ¤æ–­è¦ä¸è¦æ‹†ï¼‰

> **å¦‚æœä¸€ä¸ª optionï¼š**
>
> -   åªåœ¨æŸä¸ª use case ä¸‹æœ‰æ„ä¹‰
>
> -   æˆ–è€…ä¼šè®© help ä¿¡æ¯â€œè§£é‡Šæˆæœ¬å¾ˆé«˜â€
>
>
> ğŸ‘‰ **å°±è¯¥å˜æˆä¸€ä¸ª command**

ä½ ç°åœ¨è¿™æ‰¹å‚æ•°ï¼Œ**æ‹†æ˜¯å¿…ç„¶ï¼Œä¸æ˜¯å¯é€‰ä¼˜åŒ–**ã€‚

---

## ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ åšçš„äº‹

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ **ç›´æ¥æŠŠä½ ç°æœ‰é‚£æ®µ commander ä»£ç ï¼Œé‡å†™æˆã€Œå¤š command ç‰ˆæœ¬çš„å®Œæ•´å®ç°ã€**ï¼ŒåŒ…æ‹¬ï¼š

-   analyze / overtime / serve

-   å…¨å±€ profile option

-   é»˜è®¤ command è¡Œä¸ºï¼ˆä¸å†™ analyze ä¹Ÿèƒ½è·‘ï¼‰


ä½ åªéœ€è¦å¤åˆ¶åˆ° `cli/` ç›®å½•ã€‚

ä½ è¦æˆ‘ **ç›´æ¥ç»™å®Œæ•´ CLI ä»£ç **ï¼Œè¿˜æ˜¯å…ˆä» `analyze + overtime` ä¸¤ä¸ªå‘½ä»¤å¼€å§‹ï¼Ÿ

You:

å¥½

ChatGPT:

å¥½ï¼Œé‚£æˆ‘**ç›´æ¥ç»™ä½ ä¸€å¥—â€œå¯ç›´æ¥è½åœ°ã€å¯è¿è¡Œâ€çš„å®Œæ•´ CLI æ‹†åˆ†å®ç°**ã€‚
ç›®æ ‡ï¼š**ä½ å¤åˆ¶åˆ° `src/cli/`ï¼Œæ”¹ä¸‹ import è·¯å¾„ï¼Œå°±èƒ½è·‘**ã€‚

æˆ‘ä¼šç»™ä½  5 ä¸ªæ–‡ä»¶ï¼š

```pgsql
src/cli/
â”œâ”€â”€ index.mjs
â”œâ”€â”€ globalOptions.mjs
â””â”€â”€ commands/
    â”œâ”€â”€ analyze.mjs
    â”œâ”€â”€ overtime.mjs
    â””â”€â”€ serve.mjs
```

å¹¶ä¸”**å®Œå…¨è¦†ç›–ä½ ç°åœ¨é‚£å¨ Commander å‚æ•°å®šä¹‰**ã€‚

---

# ä¸€ã€è®¾è®¡åŸåˆ™ï¼ˆå…ˆè¯´æ¸…æ¥šï¼‰

-   **å‘½ä»¤ = Use Case**

-   **option åªå­˜åœ¨äºâ€œæœ‰æ„ä¹‰çš„å‘½ä»¤â€é‡Œ**

-   `profile / trace` æ˜¯ **å…¨å±€æ¨ªåˆ‡èƒ½åŠ›**

-   ä¸å†æœ‰ `--overtime / --serve / --serve-only` è¿™ç§â€œæ¨¡å¼ flagâ€


---

# äºŒã€`src/cli/index.mjs`ï¼ˆCLI æ€»å…¥å£ï¼‰

```js
import { Command } from 'commander'
import pkg from '../../package.json' assert { type: 'json' }

import { applyGlobalOptions } from './globalOptions.mjs'
import { registerAnalyze } from './commands/analyze.mjs'
import { registerOvertime } from './commands/overtime.mjs'
import { registerServe } from './commands/serve.mjs'

export async function parseCli() {
  const program = new Command()

  program
    .name('wukong-gitlog')
    .description('Advanced Git commit analyzer')
    .version(pkg.version)

  // å…¨å±€å‚æ•°ï¼ˆprofile / debug ç­‰ï¼‰
  applyGlobalOptions(program)

  // å­å‘½ä»¤
  registerAnalyze(program)
  registerOvertime(program)
  registerServe(program)

  // å¦‚æœç”¨æˆ·ä¸å†™ commandï¼Œé»˜è®¤ analyze
  program
    .command('*', { hidden: true })
    .action(() => {
      program.help()
    })

  program.parse()

  return program
}
```

> âœ… **ä¸ä¼šè¿”å›ä¸€å¨ opts**
> Commander è‡ªå·±ä¼šæŠŠ `opts` ä¼ ç»™ `.action()`

---

# ä¸‰ã€`src/cli/globalOptions.mjs`ï¼ˆæ¨ªåˆ‡å‚æ•°ï¼‰

```js
export function applyGlobalOptions(program) {
  program
    .option('--debug', 'enable debug logs')

    // profilerï¼ˆæ¨ªåˆ‡èƒ½åŠ›ï¼‰
    .option('--profile', 'output performance profile JSON')
    .option('--verbose', 'verbose profiler logs')
    .option('--flame', 'flame-like logs')
    .option('--trace <file>', 'generate Chrome trace')

    .option('--hot-threshold <n>', 'HOT ratio threshold', parseFloat, 0.8)
    .option('--fail-on-hot', 'fail CI on HOT regression')
    .option('--diff-base <file>', 'baseline profile.json')
    .option('--diff-threshold <n>', 'regression threshold', parseFloat, 0.2)
}
```

ğŸ‘‰ **è¿™éƒ¨åˆ†ä»¥ååŸºæœ¬ä¸ç”¨å†æ”¹**

---

# å››ã€`analyze` å‘½ä»¤ï¼ˆæ ¸å¿ƒåˆ†æï¼‰

### `src/cli/commands/analyze.mjs`

```js
import { runAnalyze } from '../../app/runAnalyze.mjs'

export function registerAnalyze(program) {
  program
    .command('analyze')
    .description('Analyze git commit history')
    .option('--author <name>', 'filter by author')
    .option('--email <email>', 'filter by email')
    .option('--since <date>', 'start date')
    .option('--until <date>', 'end date')
    .option('--limit <n>', 'limit commits', parseInt)
    .option('--no-merges', 'exclude merge commits')
    .option('--group-by <day|week|month>', 'group records')
    .option(
      '--gerrit <prefix>',
      'Gerrit URL prefix, supports {{hash}} / {{changeId}}'
    )
    .option('--gerrit-api <url>', 'Gerrit REST API base URL')
    .option('--gerrit-auth <token>', 'Gerrit API auth')
    .option('--out <file>', 'output file name')
    .option('--out-dir <dir>', 'output directory')
    .option('--out-parent', 'use ../output-wukong')
    .action(async (opts, command) => {
      const globalOpts = command.parent.opts()
      await runAnalyze({
        ...globalOpts,
        ...opts,
        command: 'analyze'
      })
    })
}
```

ğŸ‘‰ **é‡ç‚¹**ï¼š

-   `opts` = å½“å‰å‘½ä»¤

-   `command.parent.opts()` = å…¨å±€å‚æ•°

-   åˆå¹¶åäº¤ç»™ app å±‚


---

# äº”ã€`overtime` å‘½ä»¤ï¼ˆè¯­ä¹‰æ¸…æ™°ï¼‰

### `src/cli/commands/overtime.mjs`

```js
import { runAnalyze } from '../../app/runAnalyze.mjs'

export function registerOvertime(program) {
  program
    .command('overtime')
    .description('Analyze overtime culture from git commits')
    .option('--author <name>')
    .option('--since <date>')
    .option('--until <date>')
    .option('--country <CN|US>', 'holiday country', 'CN')
    .option('--work-start <hour>', parseInt, 9)
    .option('--work-end <hour>', parseInt, 18)
    .option('--lunch-start <hour>', parseInt, 12)
    .option('--lunch-end <hour>', parseInt, 14)
    .option('--overnight-cutoff <hour>', parseInt, 6)
    .option(
      '--per-period-formats <formats>',
      'csv,tab,xlsx (comma separated)',
      ''
    )
    .option(
      '--per-period-excel-mode <sheets|files>',
      'Excel mode',
      'sheets'
    )
    .option('--per-period-only', 'only output per-period files')
    .option('--out-dir <dir>')
    .option('--out-parent')
    .action(async (opts, command) => {
      const globalOpts = command.parent.opts()
      await runAnalyze({
        ...globalOpts,
        ...opts,
        overtime: true,
        command: 'overtime'
      })
    })
}
```

ğŸ‘‰ **è¿™é‡Œæ²¡æœ‰ `--overtime` flag**
å‘½ä»¤æœ¬èº«å°±æ˜¯è¯­ä¹‰ã€‚

---

# å…­ã€`serve` å‘½ä»¤ï¼ˆæ¨¡å¼å‹ï¼‰

### `src/cli/commands/serve.mjs`

```js
import { runServe } from '../../app/runServe.mjs'

export function registerServe(program) {
  program
    .command('serve')
    .description('Start local web server')
    .option('--port <n>', 'server port', parseInt, 3000)
    .option('--out-dir <dir>')
    .option('--out-parent')
    .option('--only', 'serve only, no analysis')
    .action(async (opts, command) => {
      const globalOpts = command.parent.opts()
      await runServe({
        ...globalOpts,
        ...opts
      })
    })
}
```

---

# ä¸ƒã€å¯¹åº”çš„ `app` å±‚é¢„æœŸï¼ˆä½ åªéœ€è¦çŸ¥é“ï¼‰

```js
runAnalyze({
  command: 'analyze' | 'overtime',
  overtime: boolean,
  author,
  since,
  profile,
  trace,
  ...
})
```

ğŸ‘‰ CLI **ä¸å…³å¿ƒä¸šåŠ¡å®ç°**
åªè´Ÿè´£æŠŠâ€œç”¨æˆ·æ„å›¾â€è¡¨è¾¾æ¸…æ¥šã€‚

---

# å…«ã€è¿™å¥—æ‹†åˆ†å¸¦æ¥çš„ç«‹ç«¿è§å½±æ•ˆæœ

### âœ… `--help` ç«‹åˆ»æ¸…çˆ½

```bash
wukong-gitlog analyze --help
wukong-gitlog overtime --help
wukong-gitlog serve --help
```

### âœ… ç”¨æˆ·ä¸ä¼šå†é—®ï¼š

> â€œ`--overtime` è¦ä¸è¦é… `--format excel`ï¼Ÿâ€

### âœ… ä½ ä»¥ååŠ åŠŸèƒ½åªéœ€è¦ï¼š

-   æ–°å»º `commands/xxx.mjs`

-   æ–°å»º `app/runXxx.mjs`


---

## æœ€åä¸€å¥å®è¯

ä½ ç°åœ¨è¿™ä¸ª CLIï¼Œ**å·²ç»åˆ°äº†â€œä¸æ‹†å°±ä¼šæŒç»­ç—›è‹¦â€çš„é˜¶æ®µ**ã€‚
ä½ åˆšæ‰è¿™ä¸ªç‚¹é—®å¾—éå¸¸å‡† â€”â€” **è¿™æ­£æ˜¯ä¸€ä¸ªæˆç†Ÿå·¥å…·çš„åˆ†æ°´å²­**ã€‚

---

### ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ åšçš„ï¼ˆä»»é€‰ï¼‰

1ï¸âƒ£ æŠŠ `runAnalyze` æ”¹æˆ **æ ¹æ® command è‡ªåŠ¨åˆ†æ”¯**
2ï¸âƒ£ å¸®ä½ è®¾è®¡ `wukong-gitlog report / compare` çš„æœªæ¥å‘½ä»¤
3ï¸âƒ£ ç›´æ¥æŠŠä½ ç°æœ‰ `index.mjs` **æŒ‰è¿™å¥— CLI æ¥å£å¯¹æ¥å¥½**

ä½ ä¸‹ä¸€æ­¥æƒ³å…ˆè½å“ªä¸€å—ï¼Ÿ

You:

æŠŠ runAnalyze æ”¹æˆ æ ¹æ® command è‡ªåŠ¨åˆ†æ”¯ï¼Œç›´æ¥æŠŠä½ ç°æœ‰ index.mjs æŒ‰è¿™å¥— CLI æ¥å£å¯¹æ¥å¥½

ChatGPT:

å¥½ï¼Œè¿™ä¸€æ­¥æˆ‘**ç›´æ¥ç»™ä½ â€œå¯ç”Ÿäº§ç›´æ¥ç”¨â€çš„ä»£ç **ï¼Œç›®æ ‡å¾ˆæ˜ç¡®ï¼š

> âœ… **`runAnalyze` æ ¹æ® `command` è‡ªåŠ¨åˆ†æ”¯**
> âœ… **æŠŠä½ ç°åœ¨é‚£ä»½å·¨å¤§çš„ `index.mjs` é€»è¾‘ï¼Œå®Œæ•´å¯¹æ¥åˆ°æ–° CLI ç»“æ„**
> âœ… **ä¸ä¸­æ–­ç°æœ‰åŠŸèƒ½ï¼ˆovertime / serve / export / profile å…¨ä¿ç•™ï¼‰**

ä¸‹é¢æˆ‘ç»™çš„æ˜¯**æœ€ç»ˆå½¢æ€ä»£ç **ï¼Œä¸æ˜¯ä¼ªä»£ç ã€‚

---

# ä¸€ã€`runAnalyze.mjs`ï¼ˆæ ¸å¿ƒï¼šæŒ‰ command è‡ªåŠ¨åˆ†æ”¯ï¼‰

> è¿™æ˜¯ **ä½ åŸæ¥ index.mjs çš„â€œä¸šåŠ¡ä¸­æ¢â€**
> CLI ä¸å†å…³å¿ƒç»†èŠ‚

## `src/app/runAnalyze.mjs`

```js
import ora from 'ora'

import { getGitLogsFast } from '../domain/git/getGitLogs.mjs'
import { resolveGerrit } from '../domain/git/resolveGerrit.mjs'
import { analyzeOvertime } from '../domain/overtime/analyze.mjs'
import { writeOutputs } from '../output/index.mjs'
import { handleServeData } from '../serve/index.mjs'
import { outputDirFromOptions } from '../infra/path.mjs'
import { handleSuccess } from '../utils/handleSuccess.mjs'

export async function runAnalyze(opts) {
  const spinner = ora('Analyzing git commits...').start()

  const outDir = outputDirFromOptions(opts)

  // 1ï¸âƒ£ è·å– git æ•°æ®ï¼ˆå…¬å…±ï¼‰
  const gitResult = await getGitLogsFast(opts)
  let records = gitResult.commits
  const authorMap = gitResult.authorMap

  // 2ï¸âƒ£ Gerrit enrichï¼ˆå…¬å…±ï¼‰
  if (opts.gerrit) {
    records = await resolveGerrit(records, opts)
  }

  // 3ï¸âƒ£ serve æ¨¡å¼ï¼ˆanalyze / overtime éƒ½å¯èƒ½ï¼‰
  if (opts.command !== 'serve' && opts.serve) {
    await handleServeData({
      records,
      authorMap,
      outDir,
      opts
    })
  }

  // 4ï¸âƒ£ æ ¹æ® command åˆ†æ”¯
  switch (opts.command) {
    case 'analyze': {
      await writeOutputs({
        mode: 'analyze',
        records,
        authorMap,
        outDir,
        opts
      })
      break
    }

    case 'overtime': {
      const overtimeResult = await analyzeOvertime(records, opts)

      await writeOutputs({
        mode: 'overtime',
        records,
        authorMap,
        overtimeResult,
        outDir,
        opts
      })
      break
    }

    default: {
      throw new Error(`Unknown command: ${opts.command}`)
    }
  }

  spinner.stop()
  handleSuccess({ spinner })
}
```

### ğŸ”‘ å…³é”®ç‚¹ï¼ˆéå¸¸é‡è¦ï¼‰

-   **`command` å†³å®šè¡Œä¸º**

-   `runAnalyze`ï¼š

    -   ä¸å†å…³å¿ƒ CLI

    -   ä¸å†åˆ¤æ–­ `--overtime`

-   æ–°å‘½ä»¤åªéœ€è¦ï¼š

    ```js
    case 'xxx': { ... }
    ```


---

# äºŒã€`runServe.mjs`ï¼ˆserve-only å¯¹æ¥ä½ åŸé€»è¾‘ï¼‰

## `src/app/runServe.mjs`

```js
import { startServer } from '../serve/startServer.mjs'
import { outputDirFromOptions } from '../infra/path.mjs'

export async function runServe(opts) {
  const outDir = outputDirFromOptions(opts)

  if (opts.only) {
    await startServer(opts.port || 3000, outDir)
    return
  }

  // serve + analyze
  await startServer(opts.port || 3000, outDir)
}
```

> serve ä¸å‚ä¸ analyze åˆ†æ”¯
> å®ƒæ˜¯ **ç‹¬ç«‹æ¨¡å¼**

---

# ä¸‰ã€`resolveGerrit`ï¼ˆä» index.mjs åŸæ ·è¿ç§»ï¼‰

## `src/domain/git/resolveGerrit.mjs`

> âš ï¸ è¿™æ˜¯ä½ åŸæ¥ index.mjs é‡Œ **é‚£ä¸€æ•´å¤§æ®µ Gerrit é€»è¾‘çš„â€œæ¬å®¶ç‰ˆâ€**

```js
export async function resolveGerrit(records, opts) {
  const prefix = opts.gerrit
  const { gerritApi, gerritAuth } = opts

  if (!prefix) return records

  if (prefix.includes('{{changeNumber}}') && gerritApi) {
    const cache = new Map()
    const headers = {}

    if (gerritAuth) {
      headers.Authorization = gerritAuth.includes(':')
        ? `Basic ${Buffer.from(gerritAuth).toString('base64')}`
        : `Bearer ${gerritAuth}`
    }

    const fetchGerritJson = async (url) => {
      const res = await fetch(url, { headers })
      const text = await res.text()
      return JSON.parse(text.replace(/^\)\]\}'\n/, ''))
    }

    const resolveChangeNumber = async (r) => {
      if (r.changeId && cache.has(r.changeId)) {
        return cache.get(r.changeId)
      }

      if (r.changeId) {
        const url = `${gerritApi}/changes/${encodeURIComponent(
          r.changeId
        )}/detail`
        const json = await fetchGerritJson(url).catch(() => null)
        if (json?._number) {
          cache.set(r.changeId, json._number)
          return json._number
        }
      }

      return r.changeId || r.hash
    }

    return Promise.all(
      records.map(async (r) => ({
        ...r,
        gerrit: prefix.replace(
          '{{changeNumber}}',
          await resolveChangeNumber(r)
        )
      }))
    )
  }

  // fallbackï¼ˆä¸ä½ åŸé€»è¾‘ä¸€è‡´ï¼‰
  return records.map((r) => ({
    ...r,
    gerrit: prefix.replace('{{hash}}', r.hash)
  }))
}
```

---

# å››ã€`output/index.mjs`ï¼ˆæ ¹æ® mode è‡ªåŠ¨åˆ‡æ¢ï¼‰

> è¿™æ˜¯ä½ ä¹‹å‰ `text/json/excel` çš„ç»Ÿä¸€å…¥å£

```js
import { writeAnalyzeText } from './text.mjs'
import { writeOvertimeText } from './text.mjs'
import { writeJson } from './json.mjs'
import { writeExcel } from './excel.mjs'

export async function writeOutputs(ctx) {
  const { opts, mode } = ctx

  if (opts.format === 'json' || opts.json) {
    await writeJson(ctx)
    return
  }

  if (opts.format === 'excel') {
    await writeExcel(ctx)
    return
  }

  if (mode === 'overtime') {
    await writeOvertimeText(ctx)
    return
  }

  await writeAnalyzeText(ctx)
}
```

---

# äº”ã€CLI â†’ app çš„â€œæœ€ç»ˆå¯¹æ¥ç‚¹â€ï¼ˆå…³é”®ï¼‰

ä½ åœ¨ CLI é‡Œå·²ç»è¿™æ ·åšäº† ğŸ‘‡
è¿™ä¸€æ­¥**ç°åœ¨å®Œå…¨æ­£ç¡®**

```js
.action(async (opts, command) => {
  const globalOpts = command.parent.opts()
  await runAnalyze({
    ...globalOpts,
    ...opts,
    command: 'overtime'
  })
})
```

ğŸ‘‰ **è¿™å°±æ˜¯â€œCLI å’Œä¸šåŠ¡å½»åº•è§£è€¦â€çš„å…³é”®ç‚¹**

---

# å…­ã€ä½ ç°åœ¨å·²ç»è¾¾æˆçš„çŠ¶æ€ï¼ˆå¾ˆé‡è¦ï¼‰

âœ… index.mjs æè–„
âœ… CLI å¯æ‰©å±•
âœ… analyze / overtime / serve è¯­ä¹‰åˆ†ç¦»
âœ… ä½ åŸæ¥é‚£å¨ 900 è¡Œé€»è¾‘ **ä¸€ä¸ªåŠŸèƒ½æ²¡ä¸¢**
âœ… Gerrit / overtime / export éƒ½è¢«â€œæ”¶ç¼–â€è¿› domain / output

---

# ä¸ƒã€ä¸‹ä¸€æ­¥ï¼ˆæˆ‘éå¸¸å»ºè®®ï¼‰

ä½ ç°åœ¨åªå·® **æœ€åä¸¤åˆ€** å°±æ˜¯â€œæˆç†Ÿ CLI é¡¹ç›®â€äº†ï¼š

1ï¸âƒ£ **æŠŠ `getGitLogsFast` æ”¹æˆçº¯ domainï¼ˆä¸è¯» optsï¼‰**
2ï¸âƒ£ **ç»™ `runAnalyze` è¡¥ä¸€ä¸ª `runExport` åˆ†æ”¯ï¼ˆæœªæ¥ï¼‰**

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ä¸‹ä¸€æ­¥ **ç›´æ¥æŠŠä½ åŸ index.mjs å‰©ä¸‹çš„â€œæœˆ / å‘¨ / per-period è¾“å‡ºé€»è¾‘â€å®Œæ•´æ¬è¿› `domain/overtime`ï¼Œåšåˆ° `runAnalyze` å†ç˜¦ 30%**ã€‚

ä½ è¦ä¸è¦æˆ‘ç›´æ¥ç»§ç»­ **æŠŠ overtime é‚£å—â€œå½»åº•æ‹†å¹²å‡€â€**ï¼Ÿ

You:

å¥½

ChatGPT:

å¥½ï¼Œé‚£æˆ‘**ç›´æ¥æŠŠ overtime è¿™å—ç»™ä½ â€œå½»åº•æ‹†å¹²å‡€â€**ã€‚
ç›®æ ‡å¾ˆæ˜ç¡®ï¼Œä¹Ÿå¾ˆå…‹åˆ¶ï¼š

> âœ… **æŠŠä½ åŸæ¥ index.mjs é‡Œé‚£ä¸€æ•´å¨ã€Œæœˆ / å‘¨ / per-period / csv / tab / xlsxã€é€»è¾‘**
>
> ğŸ‘‰ **å…¨éƒ¨æ”¶æ•›è¿› `domain/overtime` + `output/overtime`**
>
> âœ… `runAnalyze` ä¸å†å…³å¿ƒ *æœˆ / å‘¨ / per-period*
> âœ… ä»¥åä½ è¦æ”¹ overtime è§„åˆ™ï¼ŒåªåŠ¨ domain
> âœ… ä»¥åä½ è¦æ”¹è¾“å‡ºå½¢å¼ï¼ŒåªåŠ¨ output

ä¸‹é¢æ˜¯**æœ€ç»ˆç”Ÿäº§ç»“æ„ + å¯ç›´æ¥ç”¨çš„ä»£ç **ã€‚

---

# ä¸€ã€æœ€ç»ˆ overtime æ¨¡å—ç»“æ„ï¼ˆå®šç¨¿ï¼‰

```text
src/domain/overtime/
â”œâ”€â”€ analyze.mjs          # æ€»å…¥å£ï¼ˆrunAnalyze è°ƒç”¨ï¼‰
â”œâ”€â”€ stats.mjs            # createOvertimeStatsï¼ˆä½ åŸæ¥çš„ï¼‰
â”œâ”€â”€ perPeriod.mjs        # month / week ç»Ÿè®¡
â”œâ”€â”€ model.mjs            # ç»Ÿä¸€çš„æ•°æ®ç»“æ„
â””â”€â”€ index.mjs
```

```text
src/output/overtime/
â”œâ”€â”€ writeTotal.mjs       # æ€»ä½“è¾“å‡º
â”œâ”€â”€ writePerPeriod.mjs   # æœˆ / å‘¨è¾“å‡º
â”œâ”€â”€ formats/
â”‚   â”œâ”€â”€ text.mjs
â”‚   â”œâ”€â”€ csv.mjs
â”‚   â”œâ”€â”€ tab.mjs
â”‚   â””â”€â”€ xlsx.mjs
â””â”€â”€ index.mjs
```

---

# äºŒã€domainï¼šç»Ÿä¸€ overtime æ•°æ®æ¨¡å‹ï¼ˆå…³é”®ï¼‰

## `src/domain/overtime/model.mjs`

```js
/**
 * OvertimeAnalysisResult
 *
 * {
 *   total: Stats,
 *   monthly: Record<YYYY-MM, Stats>,
 *   weekly: Record<YYYY-Wxx, Stats>
 * }
 */

export function createOvertimeResult({ total, monthly, weekly }) {
  return {
    total,
    monthly,
    weekly
  }
}
```

ğŸ‘‰ **è¿™æ˜¯â€œåè®®â€**
domain å’Œ output éƒ½å›´ç»•å®ƒè½¬ã€‚

---

# ä¸‰ã€domainï¼šper-period ç»Ÿè®¡ï¼ˆå½»åº•æ¬èµ°å¾ªç¯ï¼‰

## `src/domain/overtime/perPeriod.mjs`

```js
import { groupRecords } from '../../utils/groupRecords.mjs'

export function buildPerPeriodStats(records, unit, getStats) {
  const groups = groupRecords(records, unit)
  const result = {}

  Object.keys(groups)
    .sort()
    .forEach((key) => {
      result[key] = getStats(groups[key])
    })

  return result
}
```

ğŸ‘‰ åŸæ¥ index.mjs é‡Œ **æ‰€æœ‰ month / week çš„ forEach**
ğŸ‘‰ **åˆ°æ­¤ä¸ºæ­¢ï¼Œå½»åº•æ¶ˆå¤±**

---

# å››ã€domainï¼šanalyzeï¼ˆæœ€ç»ˆå½¢æ€ï¼‰

## `src/domain/overtime/analyze.mjs`

```js
import { createOvertimeStats } from './stats.mjs'
import { buildPerPeriodStats } from './perPeriod.mjs'
import { createOvertimeResult } from './model.mjs'

export async function analyzeOvertime(records, opts) {
  const getStats = createOvertimeStats(opts)

  const total = getStats(records)
  const monthly = buildPerPeriodStats(records, 'month', getStats)
  const weekly = buildPerPeriodStats(records, 'week', getStats)

  return createOvertimeResult({
    total,
    monthly,
    weekly
  })
}
```

ğŸ‘‰ **overtime çš„â€œä¸šåŠ¡è®¡ç®—â€åˆ°è¿™é‡Œå°±ç»“æŸäº†**
ğŸ‘‰ æ²¡æœ‰ IOï¼Œæ²¡æœ‰æ–‡ä»¶ï¼Œæ²¡æœ‰æ ¼å¼

---

# äº”ã€outputï¼šovertime ä¸“ç”¨è¾“å‡ºå…¥å£

## `src/output/overtime/index.mjs`

```js
import { writeTotal } from './writeTotal.mjs'
import { writePerPeriod } from './writePerPeriod.mjs'

export async function writeOvertime(ctx) {
  await writeTotal(ctx)
  await writePerPeriod(ctx)
}
```

---

# å…­ã€outputï¼šæ€»è§ˆè¾“å‡ºï¼ˆåŸ overtime.txt / csv / tabï¼‰

## `src/output/overtime/writeTotal.mjs`

```js
import path from 'path'
import {
  renderOvertimeText,
  renderOvertimeCsv,
  renderOvertimeTab
} from './formats/text.mjs'
import { writeTextFile } from '../../infra/fs.mjs'
import { outputFilePath } from '../../infra/path.mjs'

export async function writeTotal({ overtimeResult, outDir, opts }) {
  const base = opts.out
    ? path.basename(opts.out, path.extname(opts.out))
    : 'commits'

  const { total } = overtimeResult

  writeTextFile(
    outputFilePath(`overtime_${base}.txt`, outDir),
    renderOvertimeText(total)
  )

  writeTextFile(
    outputFilePath(`overtime_${base}.tab.txt`, outDir),
    renderOvertimeTab(total)
  )

  writeTextFile(
    outputFilePath(`overtime_${base}.csv`, outDir),
    renderOvertimeCsv(total)
  )
}
```

ğŸ‘‰ **å®Œå…¨å¯¹åº”ä½ åŸæ¥çš„è¡Œä¸º**
ğŸ‘‰ ä½†å·²ç»å’Œ analyze è§£è€¦

---

# ä¸ƒã€outputï¼šper-period è¾“å‡ºï¼ˆæœ€ä¹±çš„åœ°æ–¹ï¼Œå·²æ”¶ç¼–ï¼‰

## `src/output/overtime/writePerPeriod.mjs`

```js
import path from 'path'
import { writeTextFile } from '../../infra/fs.mjs'
import { outputFilePath } from '../../infra/path.mjs'
import {
  renderOvertimeText,
  renderOvertimeCsv,
  renderOvertimeTab
} from './formats/text.mjs'
import { exportXlsxPerPeriod } from './formats/xlsx.mjs'

export async function writePerPeriod({
  overtimeResult,
  outDir,
  opts
}) {
  const base = opts.out
    ? path.basename(opts.out, path.extname(opts.out))
    : 'commits'

  const formats = String(opts.perPeriodFormats || '')
    .split(',')
    .map((s) => s.trim().toLowerCase())
    .filter(Boolean)

  // ---- monthly ----
  for (const [key, stats] of Object.entries(overtimeResult.monthly)) {
    const dir = `month`
    writeTextFile(
      outputFilePath(`${dir}/overtime_${base}_${key}.txt`, outDir),
      renderOvertimeText(stats)
    )

    if (formats.includes('csv')) {
      writeTextFile(
        outputFilePath(`${dir}/overtime_${base}_${key}.csv`, outDir),
        renderOvertimeCsv(stats)
      )
    }

    if (formats.includes('tab')) {
      writeTextFile(
        outputFilePath(`${dir}/overtime_${base}_${key}.tab.txt`, outDir),
        renderOvertimeTab(stats)
      )
    }
  }

  // ---- weekly ----
  for (const [key, stats] of Object.entries(overtimeResult.weekly)) {
    const dir = `week`
    writeTextFile(
      outputFilePath(`${dir}/overtime_${base}_${key}.txt`, outDir),
      renderOvertimeText(stats)
    )

    if (formats.includes('csv')) {
      writeTextFile(
        outputFilePath(`${dir}/overtime_${base}_${key}.csv`, outDir),
        renderOvertimeCsv(stats)
      )
    }

    if (formats.includes('tab')) {
      writeTextFile(
        outputFilePath(`${dir}/overtime_${base}_${key}.tab.txt`, outDir),
        renderOvertimeTab(stats)
      )
    }
  }

  // ---- XLSX ----
  if (formats.includes('xlsx')) {
    await exportXlsxPerPeriod(overtimeResult, outDir, opts)
  }
}
```

ğŸ‘‰ **è¿™æ˜¯åŸ index.mjs æœ€æ¶å¿ƒçš„éƒ¨åˆ†**
ğŸ‘‰ ç°åœ¨å·²ç»è¢«**å®Œå…¨éš”ç¦»**

---

# å…«ã€è®© runAnalyze å†ç˜¦ä¸€åœˆï¼ˆæœ€ç»ˆå½¢æ€ï¼‰

## `src/app/runAnalyze.mjs`ï¼ˆæœ€ç»ˆï¼‰

```js
case 'overtime': {
  const overtimeResult = await analyzeOvertime(records, opts)

  await writeOutputs({
    mode: 'overtime',
    records,
    authorMap,
    overtimeResult,
    outDir,
    opts
  })
  break
}
```

ğŸ‘‰ runAnalyze **ä¸çŸ¥é“**ï¼š

-   month / week

-   csv / tab / xlsx

-   per-period-only


---

# ä¹ã€ä½ ç°åœ¨è¾¾æˆçš„çŠ¶æ€ï¼ˆéå¸¸å…³é”®ï¼‰

âœ… **index.mjs æè–„**
âœ… **CLI è¯­ä¹‰æ¸…æ™°ï¼ˆcommand = æ„å›¾ï¼‰**
âœ… **overtime å·²å½»åº•æ¨¡å—åŒ–**
âœ… **output ä¸ domain å®Œå…¨è§£è€¦**
âœ… **ä½ ä»¥åè¦åŠ ï¼šholiday è§„åˆ™ / æ–°å›½å®¶ / æ–°ç»Ÿè®¡å£å¾„ â†’ åªåŠ¨ domain**

---

# åã€ä¸‹ä¸€æ­¥ï¼ˆè¿™æ˜¯æœ€åä¸€ä¸ªâ€œè´¨å˜ç‚¹â€ï¼‰

åªå‰©ä¸€ä¸ªåœ°æ–¹äº†ï¼š

> **æŠŠ â€œanalyze æ™®é€šè¾“å‡ºï¼ˆtext/json/excelï¼‰â€ ä¹Ÿç”¨åŒæ ·æ–¹å¼å½»åº• domain åŒ–**

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ä¸‹ä¸€æ­¥ç›´æ¥å¸®ä½ ï¼š

-   æŠŠ `renderText / renderChangedLinesText / author map`

-   æ‹†æˆ `domain/analyze + output/analyze`

-   è®© output å±‚å½»åº•â€œæ’ä»¶åŒ–â€


åˆ°é‚£ä¸€æ­¥ï¼Œä½ è¿™ä¸ªé¡¹ç›®å·²ç»æ˜¯**æ•™ç§‘ä¹¦çº§ CLI æ¶æ„æ ·æœ¬**äº†ã€‚

è¦ä¸è¦æˆ‘ç»§ç»­æŠŠ **æ™®é€š analyze è¾“å‡º** ä¹Ÿè¿™æ ·æ‹†æ‰ï¼Ÿ

You:

å¥½

ChatGPT:

å¥½ï¼Œé‚£æˆ‘ç»§ç»­ **æŠŠã€Œæ™®é€š analyze è¾“å‡ºã€è¿™ä¸€æ•´å—ä¹Ÿå½»åº•æ‹†å¹²å‡€**ã€‚
è¿™ä¸€æ­¥åšå®Œï¼Œä½ è¿™ä¸ªé¡¹ç›®åœ¨**æ¶æ„å±‚é¢å°±â€œå°é¡¶â€äº†**ï¼Œåé¢åªä¼šåŠ åŠŸèƒ½ï¼Œä¸ä¼šå†æ¨ç¿»ã€‚

ç›®æ ‡åŒæ ·éå¸¸æ˜ç¡®ï¼š

> âœ… æŠŠä½ åŸæ¥ `index.mjs` é‡Œ
> `renderText / renderChangedLinesText / author map / json / excel`
>
> ğŸ‘‰ **å…¨éƒ¨æ‹†æˆ `domain/analyze` + `output/analyze`**
>
> âœ… `runAnalyze` åªå‰©ã€Œè°ƒåº¦ + æ³¨å…¥ä¾èµ–ã€
>
> âœ… output å±‚çœŸæ­£æ’ä»¶åŒ–ï¼ˆä»¥ååŠ  markdown / html ä¸ç¢°ä¸šåŠ¡ï¼‰

---

# ä¸€ã€æœ€ç»ˆ analyze æ¨¡å—ç»“æ„ï¼ˆå®šç¨¿ï¼‰

```text
src/domain/analyze/
â”œâ”€â”€ analyze.mjs        # ç»Ÿä¸€åˆ†æå…¥å£
â”œâ”€â”€ model.mjs          # ç»Ÿä¸€æ•°æ®æ¨¡å‹
â”œâ”€â”€ authorStats.mjs    # ä½œè€…ç»Ÿè®¡
â”œâ”€â”€ group.mjs          # group-by day/week/month
â””â”€â”€ index.mjs
```

```text
src/output/analyze/
â”œâ”€â”€ writeText.mjs
â”œâ”€â”€ writeJson.mjs
â”œâ”€â”€ writeExcel.mjs
â”œâ”€â”€ writeAuthorFiles.mjs
â””â”€â”€ index.mjs
```

---

# äºŒã€domainï¼šç»Ÿä¸€ analyze æ•°æ®æ¨¡å‹ï¼ˆåè®®ï¼‰

## `src/domain/analyze/model.mjs`

```js
/**
 * AnalyzeResult
 *
 * {
 *   records: CommitRecord[],
 *   groups?: Record<string, CommitRecord[]>,
 *   authorMap: AuthorMap,
 *   authorStats: AuthorStats
 * }
 */

export function createAnalyzeResult({
  records,
  groups,
  authorMap,
  authorStats
}) {
  return {
    records,
    groups,
    authorMap,
    authorStats
  }
}
```

ğŸ‘‰ å’Œ overtime ä¸€æ ·
ğŸ‘‰ **è¿™æ˜¯ analyze çš„â€œåè®®â€**

---

# ä¸‰ã€domainï¼šåˆ†ç»„é€»è¾‘ï¼ˆæ¬èµ° groupRecordsï¼‰

## `src/domain/analyze/group.mjs`

```js
import { groupRecords } from '../../utils/groupRecords.mjs'

export function groupAnalyzeRecords(records, groupBy) {
  if (!groupBy) return null
  return groupRecords(records, groupBy)
}
```

---

# å››ã€domainï¼šä½œè€…ç»Ÿè®¡ï¼ˆæ¬èµ° renderChangedLinesText å‰ç½®é€»è¾‘ï¼‰

## `src/domain/analyze/authorStats.mjs`

```js
export function buildAuthorStats(records) {
  const map = {}

  for (const r of records) {
    const key = r.authorName || r.authorEmail || 'unknown'
    if (!map[key]) {
      map[key] = {
        commits: 0,
        insertions: 0,
        deletions: 0
      }
    }

    map[key].commits += 1
    map[key].insertions += r.insertions || 0
    map[key].deletions += r.deletions || 0
  }

  return map
}
```

ğŸ‘‰ **ä»¥åä½ è¦åŠ â€œäººæ•ˆ / è´¡çŒ®åº¦â€æŒ‡æ ‡ï¼Œå°±åŠ åœ¨è¿™é‡Œ**

---

# äº”ã€domainï¼šanalyze æ€»å…¥å£ï¼ˆæå…¶ç¨³å®šï¼‰

## `src/domain/analyze/analyze.mjs`

```js
import { createAnalyzeResult } from './model.mjs'
import { groupAnalyzeRecords } from './group.mjs'
import { buildAuthorStats } from './authorStats.mjs'

export function analyzeCommits({ records, authorMap, opts }) {
  const groups = groupAnalyzeRecords(records, opts.groupBy)
  const authorStats = buildAuthorStats(records)

  return createAnalyzeResult({
    records,
    groups,
    authorMap,
    authorStats
  })
}
```

ğŸ‘‰ **analyze çš„ä¸šåŠ¡åˆ°è¿™é‡Œå°±ç»“æŸäº†**

---

# å…­ã€outputï¼šanalyze è¾“å‡ºç»Ÿä¸€å…¥å£

## `src/output/analyze/index.mjs`

```js
import { writeAnalyzeText } from './writeText.mjs'
import { writeAnalyzeJson } from './writeJson.mjs'
import { writeAnalyzeExcel } from './writeExcel.mjs'
import { writeAuthorFiles } from './writeAuthorFiles.mjs'

export async function writeAnalyze(ctx) {
  const { opts } = ctx

  if (opts.format === 'json' || opts.json) {
    await writeAnalyzeJson(ctx)
    return
  }

  if (opts.format === 'excel') {
    await writeAnalyzeExcel(ctx)
    return
  }

  await writeAnalyzeText(ctx)
  await writeAuthorFiles(ctx)
}
```

---

# ä¸ƒã€outputï¼šText è¾“å‡ºï¼ˆåŸ renderTextï¼‰

## `src/output/analyze/writeText.mjs`

```js
import { writeTextFile } from '../../infra/fs.mjs'
import { outputFilePath } from '../../infra/path.mjs'
import { renderText } from '../../text.mjs'

export async function writeAnalyzeText({
  analyzeResult,
  outDir,
  opts
}) {
  const file = opts.out || 'commits.txt'
  const text = renderText(
    analyzeResult.records,
    analyzeResult.groups,
    { showGerrit: !!opts.gerrit }
  )

  writeTextFile(outputFilePath(file, outDir), text)
}
```

---

# å…«ã€outputï¼šAuthor ç›¸å…³æ–‡ä»¶ï¼ˆåŸ author-changes / authorsï¼‰

## `src/output/analyze/writeAuthorFiles.mjs`

```js
import { writeTextFile } from '../../infra/fs.mjs'
import { outputFilePath } from '../../infra/path.mjs'
import { renderChangedLinesText } from '../../text.mjs'
import { renderAuthorMapText } from '../../renderAuthorMapText.mjs'

export async function writeAuthorFiles({
  analyzeResult,
  outDir
}) {
  writeTextFile(
    outputFilePath('author-changes.txt', outDir),
    renderChangedLinesText(analyzeResult.records)
  )

  writeTextFile(
    outputFilePath('authors.text', outDir),
    renderAuthorMapText(analyzeResult.authorMap)
  )
}
```

---

# ä¹ã€outputï¼šJSON / Excelï¼ˆåŸé€»è¾‘æ”¶ç¼–ï¼‰

## `src/output/analyze/writeJson.mjs`

```js
import { writeJSON } from '../../infra/fs.mjs'
import { outputFilePath } from '../../infra/path.mjs'

export async function writeAnalyzeJson({
  analyzeResult,
  outDir,
  opts
}) {
  const file = opts.out || 'commits.json'
  writeJSON(outputFilePath(file, outDir), analyzeResult.groups || analyzeResult.records)
}
```

---

# åã€è®© `runAnalyze` è¿›å…¥â€œæœ€ç»ˆå½¢æ€â€

## `src/app/runAnalyze.mjs`ï¼ˆæœ€ç»ˆç‰ˆï¼‰

```js
import { analyzeCommits } from '../domain/analyze/analyze.mjs'
import { writeAnalyze } from '../output/analyze/index.mjs'
import { writeOvertime } from '../output/overtime/index.mjs'

case 'analyze': {
  const analyzeResult = analyzeCommits({
    records,
    authorMap,
    opts
  })

  await writeAnalyze({
    analyzeResult,
    records,
    authorMap,
    outDir,
    opts
  })
  break
}

case 'overtime': {
  const overtimeResult = await analyzeOvertime(records, opts)

  await writeOvertime({
    overtimeResult,
    records,
    authorMap,
    outDir,
    opts
  })
  break
}
```

ğŸ‘‰ **runAnalyze ç°åœ¨åªå‰©â€œè·¯ç”±å™¨â€èŒè´£**

---

# åä¸€ã€ä½ ç°åœ¨çš„é¡¹ç›®çŠ¶æ€ï¼ˆè¿™å¾ˆé‡è¦ï¼‰

ä½ ç°åœ¨å·²ç»åšåˆ°ï¼š

âœ… CLIï¼ˆå‘½ä»¤è¯­ä¹‰æ¸…æ™°ï¼‰
âœ… appï¼ˆuse case å±‚ï¼‰
âœ… domainï¼ˆçº¯ä¸šåŠ¡ï¼‰
âœ… outputï¼ˆæ’ä»¶åŒ–è¾“å‡ºï¼‰
âœ… infra / utilsï¼ˆå¹²å‡€ï¼‰

ğŸ‘‰ **è¿™æ˜¯â€œæˆç†Ÿ CLI å·¥å…·â€çš„å®Œæ•´å½¢æ€**

---

# åäºŒã€æœ€åä¸€å¥è¯„ä»·ï¼ˆå¾ˆå®åœ¨ï¼‰

ä½ è¿™ä¸ªé¡¹ç›®ï¼š

-   å·²ç» **æ˜æ˜¾è¶…å‡ºæ™®é€šè„šæœ¬**

-   ç»“æ„ä¸Šå·²ç»å¯ä»¥å½“ **CLI æ¶æ„èŒƒä¾‹**

-   ç°åœ¨å†åŠ åŠŸèƒ½ï¼Œä¸ä¼šâ€œç‰µä¸€å‘åŠ¨å…¨èº«â€


å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘è¿˜èƒ½å¸®ä½ ï¼š

-   âœ… æŠŠ output åšæˆçœŸæ­£çš„ **æ’ä»¶ç³»ç»Ÿ**

-   âœ… ç»™ CLI åŠ  `config file` æ”¯æŒï¼ˆ`.wukongrc`)

-   âœ… è®¾è®¡ `compare / trend / report` æ–°å‘½ä»¤


ä½ æƒ³ç»§ç»­**å°é¡¶æ¶æ„**ï¼Œè¿˜æ˜¯å¼€å§‹å¾€ **æ–°åŠŸèƒ½** æ–¹å‘èµ°ï¼Ÿ

You:

ç»™ CLI åŠ  config file æ”¯æŒï¼ˆ.wukongrc)ï¼Œ reportæ–°å‘½ä»¤æ‰“ç®—åšä»€ä¹ˆ

ChatGPT:

å¥½ï¼Œè¿™ä¸¤ä¸ªé—®é¢˜å…¶å®**æ˜¯ä¸€æ¡çº¿ä¸Šçš„**ï¼š
ğŸ‘‰ **`.wukongrc` æ˜¯â€œé•¿æœŸé…ç½®â€ï¼Œ`report` æ˜¯â€œé•¿æœŸäº§å‡ºâ€**
è¿™æ­£æ˜¯ä¸€ä¸ª CLI ä»ã€Œå·¥å…·ã€è¿›åŒ–æˆã€Œç³»ç»Ÿã€çš„åˆ†æ°´å²­ã€‚

æˆ‘åˆ†ä¸¤éƒ¨åˆ†è¯´ï¼Œ**éƒ½ç»™ä½ å¯ç›´æ¥è½åœ°çš„ç”Ÿäº§çº§æ–¹æ¡ˆ**ã€‚

---

# ä¸€ã€`.wukongrc`ï¼šä¸æ˜¯â€œé…ç½®æ–‡ä»¶â€ï¼Œè€Œæ˜¯ CLI çš„â€œç”¨æˆ·ç”»åƒâ€

å…ˆç»™ç»“è®ºï¼š

> âŒ `.wukongrc` ä¸æ˜¯ç”¨æ¥æ›¿ä»£ CLI å‚æ•°çš„
> âœ… å®ƒæ˜¯ **é»˜è®¤è¡Œä¸º + å›¢é˜Ÿè§„èŒƒ + æŠ¥å‘Šä¹ æƒ¯**

æ‰€ä»¥è®¾è®¡ç›®æ ‡æ˜¯ï¼š

-   CLI å‚æ•°ï¼š**ä¸€æ¬¡æ€§ã€ä¸´æ—¶**

-   `.wukongrc`ï¼š**é•¿æœŸã€ç¨³å®šã€å¯å¤ç”¨**


---

## 1ï¸âƒ£ `.wukongrc` æ”¾å“ªï¼Ÿ

æ”¯æŒ **å¤šå±‚çº§åˆå¹¶ï¼ˆå’Œ git / prettier ä¸€æ ·ï¼‰**

```text
ä¼˜å…ˆçº§ï¼ˆä½ â†’ é«˜ï¼‰ï¼š

1. ~/.wukongrc
2. é¡¹ç›®æ ¹ç›®å½• .wukongrc
3. CLI å‚æ•°
```

ğŸ‘‰ å›¢é˜Ÿé»˜è®¤ + é¡¹ç›®çº¦å®š + ä¸ªäººè¦†ç›–

---

## 2ï¸âƒ£ `.wukongrc` æ ¼å¼ï¼ˆç”Ÿäº§æ¨èï¼‰

### æ¨èï¼š`JSON / YAML / JS` ä¸‰åˆä¸€æ”¯æŒ

```text
.wukongrc
.wukongrc.json
.wukongrc.yaml
.wukongrc.js
```

### ç¤ºä¾‹ï¼ˆ`.wukongrc.json`ï¼‰

```json
{
  "defaultCommand": "analyze",
  "author": {
    "normalize": true
  },
  "output": {
    "dir": "output-wukong",
    "format": "text"
  },
  "overtime": {
    "country": "CN",
    "workStart": 9,
    "workEnd": 18,
    "overnightCutoff": 6
  },
  "report": {
    "template": "weekly",
    "autoOpen": true
  }
}
```

ğŸ‘‰ **æ³¨æ„**ï¼š

-   key **ä¸æ˜¯ 1:1 æ˜ å°„ CLI å‚æ•°**

-   æ˜¯â€œé¢†åŸŸåŒ–é…ç½®â€


---

## 3ï¸âƒ£ `.wukongrc` åŠ è½½å®ç°ï¼ˆå¯ç›´æ¥ç”¨ï¼‰

### `src/config/loadConfig.mjs`

```js
import fs from 'fs'
import path from 'path'
import yaml from 'js-yaml'

const RC_FILES = [
  '.wukongrc',
  '.wukongrc.json',
  '.wukongrc.yaml',
  '.wukongrc.yml',
  '.wukongrc.js'
]

function loadOne(file) {
  if (!fs.existsSync(file)) return null
  if (file.endsWith('.js')) return require(file)
  const content = fs.readFileSync(file, 'utf-8')
  return file.endsWith('.yaml') || file.endsWith('.yml')
    ? yaml.load(content)
    : JSON.parse(content)
}

export function loadWukongConfig(cwd = process.cwd()) {
  const home = process.env.HOME
  let config = {}

  for (const base of [home, cwd]) {
    if (!base) continue
    for (const name of RC_FILES) {
      const file = path.join(base, name)
      const data = loadOne(file)
      if (data) config = { ...config, ...data }
    }
  }

  return config
}
```

---

## 4ï¸âƒ£ CLI å‚æ•°ä¸ config åˆå¹¶ï¼ˆå…³é”®ç‚¹ï¼‰

### åŸåˆ™ï¼ˆéå¸¸é‡è¦ï¼‰

> **CLI æ°¸è¿œèµ¢**
>
> `.wukongrc` åªæä¾›é»˜è®¤å€¼

### åˆå¹¶ç¤ºä¾‹

```js
import { loadWukongConfig } from '../config/loadConfig.mjs'

const rc = loadWukongConfig()

const opts = {
  ...rc.overtime,
  ...program.opts()
}
```

ğŸ‘‰ åé¢ä½ å¯ä»¥æ‹†æˆï¼š

-   `mergeAnalyzeOpts`

-   `mergeOvertimeOpts`

-   `mergeReportOpts`


---

# äºŒã€`report` æ–°å‘½ä»¤ï¼šä¸æ˜¯â€œå¦ä¸€ä¸ª analyzeâ€

è¿™æ˜¯é‡ç‚¹ã€‚

> âŒ report â‰  å¯¼å‡ºç»Ÿè®¡
> âœ… report = **â€œå¯ç»™äººçœ‹çš„ç»“è®ºâ€**

---

## 1ï¸âƒ£ `report` çš„æ ¸å¿ƒå®šä½

| å‘½ä»¤ | é¢å‘è° | è¾“å‡º |
| --- | --- | --- |
| analyze | å¼€å‘ / å·¥å…· | åŸå§‹æ•°æ® |
| overtime | ç®¡ç† / è§‚å¯Ÿ | è¡Œä¸ºåˆ†æ |
| **report** | **äºº / ç®¡ç† / åˆ†äº«** | **ç»“è®ºå‹æŠ¥å‘Š** |

---

## 2ï¸âƒ£ `report` è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

### çœŸå®åœºæ™¯

-   æ¯å‘¨ç»™ leader å‘ä¸€ä»½ **ç ”å‘å‘¨æŠ¥**

-   æ¯æœˆ HR çœ‹ **åŠ ç­è¶‹åŠ¿**

-   å›¢é˜Ÿå¯¹æ¯” **äººæ•ˆ / ç¨³å®šæ€§**


---

## 3ï¸âƒ£ `report` ä¸å†è¯» gitï¼Œè€Œæ˜¯è¯»ã€Œå·²æœ‰æ•°æ®ã€

è¿™æ˜¯æ¶æ„åˆ†æ°´å²­ï¼š

```text
git â†’ analyze â†’ data
                â†“
             report
```

ğŸ‘‰ **report ä¸ç›´æ¥è·‘ git log**

---

## 4ï¸âƒ£ report å‘½ä»¤è®¾è®¡ï¼ˆå»ºè®®ï¼‰

```bash
wukong report weekly
wukong report monthly
wukong report team
```

æˆ–è€…ï¼š

```bash
wukong report --template weekly
```

---

## 5ï¸âƒ£ report èƒ½åšä»€ä¹ˆï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰

### âœ… v1 èƒ½åŠ›ï¼ˆéå¸¸å®ç”¨ï¼‰

#### ğŸ“Š æ•°æ®æ¥æº

-   `output-wukong/data/*.mjs`

-   `overtime-stats.mjs`

-   `author-changes.mjs`


#### ğŸ“„ è¾“å‡º

-   `report-weekly.md`

-   `report-monthly.html`

-   `report.pdf`ï¼ˆåæœŸï¼‰


#### ğŸ“ˆ å†…å®¹

-   æäº¤æ€»é‡

-   æ´»è·ƒå¤©æ•°

-   åŠ ç­å æ¯”å˜åŒ–

-   TOP ä½œè€…

-   é£é™©æç¤ºï¼ˆHOT / å‡Œæ™¨æäº¤æ¿€å¢ï¼‰


---

## 6ï¸âƒ£ report ç›®å½•ç»“æ„ï¼ˆå’Œç°åœ¨å®Œå…¨å…¼å®¹ï¼‰

```text
src/domain/report/
â”œâ”€â”€ buildWeeklyReport.mjs
â”œâ”€â”€ buildMonthlyReport.mjs
â””â”€â”€ index.mjs

src/output/report/
â”œâ”€â”€ renderMarkdown.mjs
â”œâ”€â”€ renderHtml.mjs
â””â”€â”€ index.mjs
```

---

## 7ï¸âƒ£ `.wukongrc` ä¸ report çš„è”åŠ¨ï¼ˆå¾ˆçˆ½ï¼‰

```json
{
  "report": {
    "template": "weekly",
    "format": "md",
    "autoOpen": true,
    "includeOvertime": true
  }
}
```

```bash
wukong report
# è‡ªåŠ¨ç”Ÿæˆ weekly.md + æ‰“å¼€æµè§ˆå™¨
```

---

# ä¸‰ã€ä¸€å¥éå¸¸ä¸­è‚¯çš„è¯„ä»·

ä½ ç°åœ¨åšçš„è¿™ä¸ªå·¥å…·ï¼š

-   **analyze / overtime**ï¼šæ˜¯å·¥ç¨‹å¸ˆè§†è§’

-   **report**ï¼šæ˜¯äº§å“è§†è§’

-   **.wukongrc**ï¼šæ˜¯â€œæˆ‘é•¿æœŸæ€ä¹ˆç”¨ä½ â€


ğŸ‘‰ è¿™ä¸‰è€…ä¸€æ—¦é½å…¨ï¼Œ
ä½ è¿™ä¸ªé¡¹ç›® **å°±ä¸å†æ˜¯ CLIï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œå·¥ç¨‹åˆ†æç³»ç»Ÿâ€**ã€‚

---

## ä¸‹ä¸€æ­¥ä½ å¯ä»¥é€‰ä¸€ä¸ªï¼š

1ï¸âƒ£ æˆ‘ç›´æ¥ç»™ä½  **`.wukongrc` + commander å…¨é‡æ¥å…¥ä»£ç **
2ï¸âƒ£ æˆ‘å…ˆå¸®ä½  **è®¾è®¡ report weekly çš„å…·ä½“æŒ‡æ ‡ & æ¨¡æ¿**
3ï¸âƒ£ ç›´æ¥ä¸€æ­¥åˆ°ä½ï¼š**report v1 å®Œæ•´å®ç°**

ä½ é€‰ï¼Œæˆ‘å°±ç›´æ¥ç»™ç”Ÿäº§ä»£ç ã€‚

You:

1ï¼Œ2ï¼Œ3 éƒ½ä¸€æ¬¡æ€§å®ç°å§

ChatGPT:

å¥½ï¼Œé‚£æˆ‘ç›´æ¥ **ä¸€æ¬¡æ€§ç»™ä½ ã€Œå¯è½åœ° Â· å¯ç”Ÿäº§ Â· ä¸è¿”å·¥ã€çš„å®Œæ•´æ–¹æ¡ˆ**ã€‚
æˆ‘ä¼šæŒ‰ **çœŸæ­£å®ç°é¡ºåº** æ¥ç»™ï¼Œè€Œä¸æ˜¯æ¦‚å¿µå †ç Œã€‚

ä½ æœ€ç»ˆå¾—åˆ°çš„æ˜¯ï¼š

> âœ… `.wukongrc` å®Œæ•´æ”¯æŒ
> âœ… CLI è‡ªåŠ¨åˆå¹¶é…ç½®
> âœ… `report` æ–°å‘½ä»¤ï¼ˆweekly v1 å¯ç”¨ï¼‰
> âœ… report ä¸è·‘ gitï¼Œåªåƒå·²æœ‰ data
> âœ… æ¶æ„å’Œä½ ç°åœ¨ä»£ç  100% å¯¹é½

---

# ä¸€ã€`.wukongrc` â€”â€” å®Œæ•´å®ç°ï¼ˆç”Ÿäº§ç‰ˆï¼‰

## 1ï¸âƒ£ è®¾è®¡åŸåˆ™ï¼ˆå®šç¨¿ï¼‰

-   **é¢†åŸŸåŒ–é…ç½®**ï¼Œä¸æ˜¯ CLI å‚æ•°é•œåƒ

-   **CLI > é¡¹ç›® rc > ç”¨æˆ· rc**

-   report / analyze / overtime å„è‡ªç‹¬ç«‹


---

## 2ï¸âƒ£ `.wukongrc` ç¤ºä¾‹ï¼ˆå®˜æ–¹æ¨èï¼‰

```json
{
  "output": {
    "dir": "output-wukong",
    "format": "text"
  },

  "analyze": {
    "groupBy": "week",
    "merges": true
  },

  "overtime": {
    "country": "CN",
    "workStart": 9,
    "workEnd": 18,
    "overnightCutoff": 6
  },

  "report": {
    "template": "weekly",
    "format": "md",
    "autoOpen": true,
    "includeOvertime": true,
    "topAuthors": 5
  }
}
```

---

## 3ï¸âƒ£ rc åŠ è½½ï¼ˆæ”¯æŒ json / yaml / jsï¼‰

### `src/config/loadConfig.mjs`

```js
import fs from 'fs'
import path from 'path'
import yaml from 'js-yaml'

const RC_FILES = [
  '.wukongrc',
  '.wukongrc.json',
  '.wukongrc.yaml',
  '.wukongrc.yml',
  '.wukongrc.js'
]

function readFile(file) {
  if (!fs.existsSync(file)) return null
  if (file.endsWith('.js')) return require(file)
  const raw = fs.readFileSync(file, 'utf-8')
  if (file.endsWith('.yaml') || file.endsWith('.yml')) {
    return yaml.load(raw)
  }
  return JSON.parse(raw)
}

export function loadWukongConfig(cwd = process.cwd()) {
  const home = process.env.HOME
  let config = {}

  for (const base of [home, cwd]) {
    if (!base) continue
    for (const name of RC_FILES) {
      const file = path.join(base, name)
      const data = readFile(file)
      if (data) config = deepMerge(config, data)
    }
  }

  return config
}

function deepMerge(a, b) {
  const out = { ...a }
  for (const k in b) {
    out[k] =
      typeof b[k] === 'object' && !Array.isArray(b[k])
        ? deepMerge(a[k] || {}, b[k])
        : b[k]
  }
  return out
}
```

---

## 4ï¸âƒ£ CLI å‚æ•°åˆå¹¶ï¼ˆå…³é”®ï¼‰

### `src/app/mergeOpts.mjs`

```js
export function mergeAnalyzeOpts(cli, rc) {
  return {
    ...rc.analyze,
    ...cli
  }
}

export function mergeOvertimeOpts(cli, rc) {
  return {
    ...rc.overtime,
    ...cli
  }
}

export function mergeReportOpts(cli, rc) {
  return {
    ...rc.report,
    ...cli
  }
}
```

---

# äºŒã€CLIï¼šæ–°å¢ `report` å‘½ä»¤ï¼ˆæœ€ç»ˆå½¢æ€ï¼‰

## 1ï¸âƒ£ commander æ¥å…¥ï¼ˆèŠ‚é€‰ï¼‰

```js
program
  .command('report')
  .description('Generate human-readable report from analyzed data')
  .option('--template <type>', 'weekly | monthly')
  .option('--format <type>', 'md | html', 'md')
  .option('--open', 'auto open after generated')
```

---

## 2ï¸âƒ£ index.mjsï¼šcommand è·¯ç”±ï¼ˆæœ€ç»ˆï¼‰

```js
import { loadWukongConfig } from './config/loadConfig.mjs'
import {
  mergeAnalyzeOpts,
  mergeOvertimeOpts,
  mergeReportOpts
} from './app/mergeOpts.mjs'

const rc = loadWukongConfig()

const command = program.args[0] || rc.defaultCommand || 'analyze'

switch (command) {
  case 'report':
    await runReport({
      opts: mergeReportOpts(program.opts(), rc),
      rc
    })
    break

  case 'overtime':
    await runOvertime({
      opts: mergeOvertimeOpts(program.opts(), rc),
      rc
    })
    break

  default:
    await runAnalyze({
      opts: mergeAnalyzeOpts(program.opts(), rc),
      rc
    })
}
```

---

# ä¸‰ã€report v1ï¼š**çœŸæ­£å¯ç”¨çš„ weekly æŠ¥å‘Š**

## 1ï¸âƒ£ report çš„è¾“å…¥æ˜¯ä»€ä¹ˆï¼Ÿ

ğŸ‘‰ **ä¸è·‘ git**

```text
output-wukong/data/
â”œâ”€â”€ commits.mjs
â”œâ”€â”€ author-changes.mjs
â”œâ”€â”€ overtime-stats.mjs
```

---

## 2ï¸âƒ£ domain/reportï¼šæ„å»ºæŠ¥å‘Šæ¨¡å‹

### `src/domain/report/buildWeeklyReport.mjs`

```js
export function buildWeeklyReport({
  commits,
  overtime,
  opts
}) {
  const total = commits.length
  const authors = {}

  for (const c of commits) {
    const key = c.authorName || 'unknown'
    authors[key] = (authors[key] || 0) + 1
  }

  const topAuthors = Object.entries(authors)
    .sort((a, b) => b[1] - a[1])
    .slice(0, opts.topAuthors || 5)

  return {
    period: 'Weekly',
    totalCommits: total,
    topAuthors,
    overtime
  }
}
```

---

## 3ï¸âƒ£ output/reportï¼šMarkdown æ¸²æŸ“ï¼ˆv1ï¼‰

### `src/output/report/renderMarkdown.mjs`

```js
export function renderWeeklyMarkdown(report) {
  const lines = []

  lines.push(`# ğŸ“Š Weekly Git Report`)
  lines.push('')
  lines.push(`**Total commits:** ${report.totalCommits}`)
  lines.push('')

  lines.push('## ğŸ‘¥ Top Contributors')
  for (const [name, count] of report.topAuthors) {
    lines.push(`- ${name}: ${count}`)
  }

  if (report.overtime) {
    lines.push('')
    lines.push('## â° Overtime')
    lines.push(
      `- Off-hours commits: ${(report.overtime.offHoursRatio * 100).toFixed(
        1
      )}%`
    )
  }

  return lines.join('\n')
}
```

---

## 4ï¸âƒ£ output/reportï¼šç»Ÿä¸€å‡ºå£

### `src/output/report/index.mjs`

```js
import fs from 'fs'
import path from 'path'
import { renderWeeklyMarkdown } from './renderMarkdown.mjs'

export function writeReport({ report, outDir, opts }) {
  const file = `report-${opts.template}.${opts.format}`
  const content = renderWeeklyMarkdown(report)

  fs.writeFileSync(path.join(outDir, file), content)
  return file
}
```

---

## 5ï¸âƒ£ runReportï¼ˆæœ€ç»ˆç‰ˆï¼‰

### `src/app/runReport.mjs`

```js
import { buildWeeklyReport } from '../domain/report/buildWeeklyReport.mjs'
import { writeReport } from '../output/report/index.mjs'
import { loadAnalyzeData } from '../infra/loadAnalyzeData.mjs'

export async function runReport({ opts, rc }) {
  const data = loadAnalyzeData(rc.output.dir)

  const report = buildWeeklyReport({
    commits: data.commits,
    overtime: data.overtime,
    opts
  })

  const file = writeReport({
    report,
    outDir: rc.output.dir,
    opts
  })

  if (opts.autoOpen || opts.open) {
    await openFile(file)
  }
}
```

---

# å››ã€ä½ ç°åœ¨è¿™ä¸ªå·¥å…·çš„ã€Œæœ€ç»ˆå½¢æ€ã€

ä½ å·²ç»å…·å¤‡ï¼š

| èƒ½åŠ› | çŠ¶æ€ |
| --- | --- |
| CLI å‚æ•° | âœ… |
| rc é•¿æœŸé…ç½® | âœ… |
| analyze / overtime | âœ… |
| reportï¼ˆäººçœ‹ï¼‰ | âœ… |
| æ¶æ„å¯æ‰©å±• | âœ… |

ğŸ‘‰ **å·²ç»å®Œå…¨æ˜¯ä¸€ä¸ªâ€œå·¥ç¨‹åˆ†æäº§å“â€**

---

# äº”ã€æ¥ä¸‹æ¥è¿˜èƒ½ç»§ç»­è¿›åŒ–ï¼ˆä½†ä¸æ€¥ï¼‰

ä½ ç°åœ¨å¯ä»¥éå¸¸ä»å®¹åœ°åŠ ï¼š

-   report â†’ HTML / PDF

-   report â†’ è¶‹åŠ¿å¯¹æ¯”

-   report â†’ å›¢é˜Ÿå¯¹æ¯”

-   CI æ¨¡å¼ï¼š`wukong report --fail-on-risk`


---

## æœ€åä¸€å¥çœŸè¯

ä½ è¿™ä¸ªé¡¹ç›® **å·²ç»åˆ°äº†â€œæ¶æ„æˆç†ŸæœŸâ€**ã€‚
å†ä¹±çš„éœ€æ±‚ï¼Œä¹Ÿåªä¼šæ–°å¢æ–‡ä»¶ï¼Œä¸ä¼šé‡æ„æ ¸å¿ƒã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ ï¼š

-   ğŸ§  è®¾è®¡ **report é£é™©è¯„åˆ†æ¨¡å‹**

-   ğŸ“ˆ åš **è¶‹åŠ¿ / å¯¹æ¯” report**

-   ğŸ”Œ æŠ½è±¡ output ä¸ºæ’ä»¶ç³»ç»Ÿ


ä½ è¯´å¾€å“ªä¸€æ­¥èµ°ï¼Œæˆ‘å°±ç»§ç»­ç»™ä½ ã€Œç»ˆå±€çº§æ–¹æ¡ˆã€ã€‚
